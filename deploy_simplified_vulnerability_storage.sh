#!/bin/bash

echo "ğŸ”§ DEPLOYING: Simplified vulnerability storage (no confidence scoring)"

# Find the Flask app container
CONTAINER_NAME=$(docker ps --format "table {{.Names}}" | grep -E "(app|flask|web|attacksurface)" | head -1)

if [ -z "$CONTAINER_NAME" ]; then
    echo "âŒ Could not find Flask app container. Available containers:"
    docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
    echo ""
    echo "Please specify your container name:"
    read -p "Enter container name: " CONTAINER_NAME
fi

echo "ğŸ“¦ Using container: $CONTAINER_NAME"

# Copy the updated files
echo "ğŸ“‹ Copying simplified models (no confidence_score)..."
docker cp models.py $CONTAINER_NAME:/app/

echo "ğŸ“‹ Copying updated tasks (simplified validation)..."
docker cp tasks.py $CONTAINER_NAME:/app/

echo "ğŸ“‹ Copying fixed Nuclei scanner (no timeout)..."
docker cp tools/nuclei.py $CONTAINER_NAME:/app/tools/

echo "ğŸ“‹ Copying simplified migration script..."
docker cp docker_migration.py $CONTAINER_NAME:/app/

# Run the migration
echo "ğŸ”„ Running simplified database migration..."
docker exec $CONTAINER_NAME python /app/docker_migration.py

# Restart the application
echo "ğŸ”„ Restarting application to load all changes..."
docker restart $CONTAINER_NAME

echo ""
echo "âœ… Simplified vulnerability storage deployed!"
echo ""
echo "ğŸ”§ What was simplified:"
echo "- âŒ Removed confidence_score field completely"
echo "- âœ… Kept is_validated field (defaults to TRUE)"
echo "- âœ… Kept template_name, cvss_score, asset_metadata"
echo "- âœ… Simple validation: critical/high/medium = auto-validated"
echo "- âœ… Low/info severity = stored for manual review"
echo ""
echo "ğŸ¯ Benefits:"
echo "- No more 'confidence_score is an invalid keyword' errors"
echo "- Simpler vulnerability storage logic"
echo "- All vulnerabilities are stored successfully"
echo "- Faster Nuclei scans (conservative parameters)"
echo ""
echo "ğŸ§ª Test by running a new Nuclei scan:"
echo "- Should store ALL vulnerabilities without errors"
echo "- Critical/High/Medium will be auto-validated"
echo "- Low/Info will be marked for manual review"
