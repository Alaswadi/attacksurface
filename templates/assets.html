{% extends "base.html" %}

{% block title %}Assets - Attack Surface Monitoring{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-gray-700 flex flex-col text-white transition-all duration-300 ease-in-out w-16">
        <!-- Logo Section -->
        <div class="flex items-center justify-center py-4 mb-4">
            <div class="w-10 h-10 flex items-center justify-center">
                <i class="ri-shield-keyhole-line ri-lg text-blue-400"></i>
            </div>
            <span id="logo-text" class="ml-3 text-lg font-semibold text-blue-400 opacity-0 transition-opacity duration-300 whitespace-nowrap">AttackSurface</span>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-2">
            <!-- Dashboard -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" data-section="dashboard" title="Dashboard">
                <div class="flex items-center">
                    <i class="ri-dashboard-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Dashboard</span>
                </div>
            </div>

            <!-- Assets -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer bg-gray-600 transition-colors relative" data-section="assets" title="Assets">
                <div class="flex items-center">
                    <i class="ri-computer-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Assets</span>
                </div>
            </div>

            <!-- Vulnerabilities -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" data-section="vulnerabilities" title="Vulnerabilities">
                <div class="flex items-center">
                    <i class="ri-shield-check-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Vulnerabilities</span>
                </div>
            </div>

            <!-- Alerts -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" data-section="alerts" title="Alerts">
                <div class="flex items-center">
                    <i class="ri-alert-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Alerts</span>
                    <span class="alert-badge ml-auto bg-red-500 text-white text-xs rounded-full px-2 py-1 nav-text opacity-0 transition-opacity duration-300">3</span>
                </div>
            </div>

            <!-- Technologies -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" onclick="window.location.href='/technologies'" title="Technology Discovery">
                <div class="flex items-center">
                    <i class="ri-stack-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Technologies</span>
                </div>
            </div>



            <!-- Reports -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" data-section="reports" title="Reports">
                <div class="flex items-center">
                    <i class="ri-file-chart-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Reports</span>
                </div>
            </div>

            <!-- Settings -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors relative" data-section="settings" title="Settings">
                <div class="flex items-center">
                    <i class="ri-settings-3-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Settings</span>
                </div>
            </div>
        </nav>

        <!-- Toggle Button -->
        <div class="p-2">
            <button id="sidebar-toggle" class="w-full p-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center" title="Toggle Sidebar">
                <i class="ri-menu-line ri-lg min-w-[24px]"></i>
                <span id="toggle-text" class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Expand</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6">
            <h1 class="text-xl font-semibold text-gray-800">Assets</h1>

            <div class="flex items-center space-x-4">
                <!-- Search -->
                <div class="relative">
                    <input type="search" id="asset-search" placeholder="Search assets..."
                           class="w-80 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <i class="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <!-- Add Asset Button -->
                <button id="add-asset-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                    <i class="ri-add-line mr-2"></i>Add Asset
                </button>

                <!-- User Menu -->
                <div class="relative">
                    <button class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100" onclick="toggleUserMenu()">
                        <i class="ri-user-line text-gray-600"></i>
                    </button>
                    <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                        <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Progressive Scanning Notification -->
        <div id="progressive-scanning-notification" class="bg-blue-50 border-l-4 border-blue-400 p-4 mx-6 mt-4 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                    <div class="flex-1">
                        <h3 class="text-blue-800 font-semibold">Progressive Scanning Active</h3>
                        <p class="text-blue-700 text-sm mb-2">Assets are being populated in real-time as scanning progresses. New subdomains, HTTP status codes, and port information will appear automatically.</p>
                        <div id="notification-progress-stats" class="flex space-x-4 text-xs text-blue-600">
                            <span>Subdomains: <span id="notification-subdomains">0</span></span>
                            <span>Assets: <span id="notification-assets">0</span></span>
                            <span>Updates: <span id="notification-updates">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="view-scan-progress" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 border border-blue-300 rounded">
                        View Progress
                    </button>
                    <button onclick="hideProgressiveNotification()" class="text-blue-600 hover:text-blue-800">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Assets Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="card bg-white rounded shadow-sm border border-gray-100 p-6">
                    <h3 class="text-gray-500 font-medium mb-2">Total Assets</h3>
                    <p class="text-5xl font-semibold text-gray-800">{{ total_assets }}</p>
                    <p class="text-sm text-gray-500 mt-1">All discovered assets</p>
                </div>

                <div class="card bg-white rounded shadow-sm border border-gray-100 p-6">
                    <h3 class="text-gray-500 font-medium mb-2">At Risk</h3>
                    <p class="text-5xl font-semibold text-orange-600">{{ at_risk }}</p>
                    <p class="text-sm text-gray-500 mt-1">Assets with vulnerabilities</p>
                </div>

                <div class="card bg-white rounded shadow-sm border border-gray-100 p-6">
                    <h3 class="text-gray-500 font-medium mb-2">Critical Exposure</h3>
                    <p class="text-5xl font-semibold text-red-600">{{ critical_exposure }}</p>
                    <p class="text-sm text-gray-500 mt-1">Critical vulnerabilities</p>
                </div>

                <div class="card bg-white rounded shadow-sm border border-gray-100 p-6">
                    <h3 class="text-gray-500 font-medium mb-2">Secure</h3>
                    <p class="text-5xl font-semibold text-green-600">{{ secure_assets }}</p>
                    <p class="text-sm text-gray-500 mt-1">No known vulnerabilities</p>
                </div>
            </div>

            <!-- Asset Type Tabs -->
            <div class="bg-white rounded shadow-sm border border-gray-100 mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-type="all">
                            All
                        </button>
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="domain">
                            Domains
                        </button>
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="ip_address">
                            IPs
                        </button>
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="subdomain">
                            Subdomains
                        </button>
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="cloud_resource">
                            Cloud
                        </button>
                        <button class="asset-type-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="service">
                            Apps
                        </button>
                    </nav>
                </div>

                <!-- Filters -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex space-x-4">
                        <!-- Status Filter -->
                        <div class="relative">
                            <select id="status-filter" class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <i class="ri-arrow-down-s-line absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>

                        <!-- Risk Level Filter -->
                        <div class="relative">
                            <select id="risk-filter" class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Risk Level</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="none">None</option>
                            </select>
                            <i class="ri-arrow-down-s-line absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>

                        <!-- Tags Filter -->
                        <div class="relative">
                            <select id="tags-filter" class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Tags</option>
                                <option value="production">Production</option>
                                <option value="staging">Staging</option>
                                <option value="development">Development</option>
                            </select>
                            <i class="ri-arrow-down-s-line absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Assets Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="name">
                                    Asset Name
                                    <i class="ri-arrow-up-down-line ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="type">
                                    Type
                                    <i class="ri-arrow-up-down-line ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="status">
                                    Status / HTTP
                                    <i class="ri-arrow-up-down-line ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ports
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="risk">
                                    Risk Level
                                    <i class="ri-arrow-up-down-line ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="last_scan">
                                    Last Scan
                                    <i class="ri-arrow-up-down-line ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="assets-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Assets will be loaded here via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="p-8 text-center">
                    <i class="ri-loader-4-line text-2xl text-gray-400 animate-spin"></i>
                    <p class="text-gray-500 mt-2">Loading assets...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="p-8 text-center hidden">
                    <i class="ri-computer-line text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No assets found</h3>
                    <p class="text-gray-500 mb-4">Get started by adding your first asset or running a scan.</p>
                    <button id="empty-add-asset-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="ri-add-line mr-2"></i>Add Asset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div id="add-asset-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Large-Scale Attack Surface Scanning</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <!-- Scan Configuration -->
                <div id="add-asset-scan-config-section" class="mb-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Domain</label>
                            <input type="text" id="add-asset-domain-input" placeholder="e.g., example.com"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Enter the root domain to scan for attack surface discovery</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Scan Type</label>
                            <select id="add-asset-scan-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="quick">Quick Scan (Fast, essential checks)</option>
                                <option value="deep">Deep Scan (Thorough, detailed analysis)</option>
                                <option value="comprehensive">Comprehensive Scan (Complete, all checks)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Quick scans complete faster, comprehensive scans find more assets</p>
                        </div>

                        <button id="start-add-asset-scan" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors font-medium">
                            <i class="ri-rocket-line mr-2"></i>Start Progressive Scan
                        </button>
                    </div>
                </div>

                <!-- Scan Progress Section -->
                <div id="add-asset-progress-section" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-green-900">
                                <i class="ri-loader-4-line animate-spin mr-2"></i>Progressive Scan Active
                            </h4>
                            <span id="add-asset-task-id" class="text-xs text-green-700 font-mono"></span>
                        </div>
                        <p id="add-asset-current-stage" class="text-sm text-green-800 mb-2">Initializing scan...</p>

                        <!-- Progress Bar -->
                        <div class="w-full bg-green-200 rounded-full h-2 mb-3">
                            <div id="add-asset-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>

                        <!-- Statistics -->
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div id="add-asset-subdomains-found" class="text-lg font-semibold text-green-700">0</div>
                                <div class="text-xs text-green-600">Subdomains Found</div>
                            </div>
                            <div>
                                <div id="add-asset-assets-stored" class="text-lg font-semibold text-green-700">0</div>
                                <div class="text-xs text-green-600">Assets Stored</div>
                            </div>
                            <div>
                                <div id="add-asset-progressive-updates" class="text-lg font-semibold text-green-700">0</div>
                                <div class="text-xs text-green-600">Updates Received</div>
                            </div>
                        </div>
                    </div>

                    <!-- Real-time Log -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-32 overflow-y-auto">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Real-time Progress</h5>
                        <div id="add-asset-scan-log" class="text-xs text-gray-600 space-y-1">
                            <!-- Log entries will be added here -->
                        </div>
                    </div>

                    <div class="mt-4 flex justify-between">
                        <button id="view-assets-during-add-asset-scan" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="ri-eye-line mr-2"></i>View Assets (Live Updates)
                        </button>
                        <button id="stop-add-asset-scan" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="ri-stop-line mr-2"></i>Stop Scan
                        </button>
                    </div>
                </div>

                <!-- Scan Results Section -->
                <div id="add-asset-results-section" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <h4 class="font-medium text-green-900 mb-2">
                            <i class="ri-check-line mr-2"></i>Scan Completed Successfully
                        </h4>
                        <p class="text-sm text-green-800">Progressive scan completed. All discovered assets have been added to your inventory.</p>
                    </div>

                    <div id="add-asset-scan-summary" class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Summary will be populated here -->
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button id="close-add-asset-results" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Close
                        </button>
                        <button id="view-discovered-add-asset-assets" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class="ri-eye-line mr-2"></i>View Discovered Assets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- All Ports Modal -->
<div id="all-ports-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="ports-modal-title">All Ports</h3>
                <button onclick="hideAllPortsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <div id="all-ports-list" class="space-y-2">
                    <!-- Ports will be populated here -->
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="hideAllPortsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- All Technologies Modal -->
<div id="all-technologies-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="technologies-modal-title">All Technologies</h3>
                <button onclick="hideTechnologiesModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <div id="all-technologies-list" class="space-y-2">
                    <!-- Technologies will be populated here -->
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="hideTechnologiesModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Confirm Deletion</h3>
                <button onclick="hideDeleteConfirmationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-sm text-gray-600" id="delete-confirmation-message">
                    Are you sure you want to delete this asset?
                </p>
                <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-xs text-yellow-800" id="delete-warning-message">
                        This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteConfirmationModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button onclick="executeDelete()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Global variables
let sidebarExpanded = localStorage.getItem('sidebarExpanded') === 'true';
let currentAssetType = 'all';
let currentSort = { field: 'name', direction: 'asc' };
let assetsData = [];

// Progressive scanning variables
let progressiveEventSource = null;
let progressiveScanTaskId = null;
let progressiveScanActive = false;
let progressiveUpdateCount = 0;



// Add Asset modal scanning variables
let addAssetEventSource = null;
let addAssetScanTaskId = null;
let addAssetScanActive = false;
let addAssetUpdateCount = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeSidebar();
    initializeAssetTabs();
    initializeFilters();
    initializeSearch();
    initializeSorting();
    loadAssets();
    initializeModals();
    initializeScanning();

    // Add click event to toggle button
    document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);

    // Add click events to navigation items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            if (section === 'dashboard') {
                window.location.href = '/dashboard';
            } else if (section === 'vulnerabilities') {
                window.location.href = '/vulnerabilities';
            } else if (section === 'alerts') {
                window.location.href = '/alerts';
            } else if (section === 'reports') {
                window.location.href = '/reports';
            } else if (section === 'settings') {
                window.location.href = '/settings';
            }
            // Add other navigation logic here
        });
    });
});

// Sidebar functionality (same as dashboard)
function initializeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const logoText = document.getElementById('logo-text');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleButton = document.getElementById('sidebar-toggle');

    if (sidebarExpanded) {
        expandSidebar();
    } else {
        collapseSidebar();
    }
}

function expandSidebar() {
    const sidebar = document.getElementById('sidebar');
    const logoText = document.getElementById('logo-text');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleIcon = document.querySelector('#sidebar-toggle i');
    const toggleText = document.getElementById('toggle-text');

    sidebar.classList.remove('w-16');
    sidebar.classList.add('w-64');

    setTimeout(() => {
        logoText.classList.remove('opacity-0');
        logoText.classList.add('opacity-100');
        navTexts.forEach(text => {
            text.classList.remove('opacity-0');
            text.classList.add('opacity-100');
        });
    }, 150);

    toggleIcon.className = 'ri-menu-fold-line ri-lg';
    toggleText.textContent = 'Collapse';
    document.getElementById('sidebar-toggle').title = 'Collapse sidebar';

    sidebarExpanded = true;
    localStorage.setItem('sidebarExpanded', 'true');
}

function collapseSidebar() {
    const sidebar = document.getElementById('sidebar');
    const logoText = document.getElementById('logo-text');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleIcon = document.querySelector('#sidebar-toggle i');
    const toggleText = document.getElementById('toggle-text');

    logoText.classList.remove('opacity-100');
    logoText.classList.add('opacity-0');
    navTexts.forEach(text => {
        text.classList.remove('opacity-100');
        text.classList.add('opacity-0');
    });

    setTimeout(() => {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-16');
    }, 150);

    toggleIcon.className = 'ri-menu-line ri-lg';
    toggleText.textContent = 'Expand';
    document.getElementById('sidebar-toggle').title = 'Expand sidebar';

    sidebarExpanded = false;
    localStorage.setItem('sidebarExpanded', 'false');
}

function toggleSidebar() {
    if (sidebarExpanded) {
        collapseSidebar();
    } else {
        expandSidebar();
    }
}

function toggleUserMenu() {
    const menu = document.getElementById('userMenu');
    menu.classList.toggle('hidden');
}

// Close user menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('userMenu');
    const button = event.target.closest('button');
    if (!button || !button.onclick) {
        menu.classList.add('hidden');
    }
});

// Asset type tabs
function initializeAssetTabs() {
    document.querySelectorAll('.asset-type-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const assetType = this.getAttribute('data-type');
            setActiveAssetTab(assetType);
            currentAssetType = assetType;
            filterAssets();
        });
    });
}

function setActiveAssetTab(assetType) {
    document.querySelectorAll('.asset-type-tab').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });

    const activeTab = document.querySelector(`[data-type="${assetType}"]`);
    if (activeTab) {
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-blue-500', 'text-blue-600');
    }
}

// Filters
function initializeFilters() {
    ['status-filter', 'risk-filter', 'tags-filter'].forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', filterAssets);
    });
}

// Search
function initializeSearch() {
    const searchInput = document.getElementById('asset-search');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterAssets, 300);
    });
}

// Sorting
function initializeSorting() {
    document.querySelectorAll('[data-sort]').forEach(header => {
        header.addEventListener('click', function() {
            const field = this.getAttribute('data-sort');
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            sortAssets();
            renderAssets();
        });
    });
}

// Load assets from API
async function loadAssets() {
    try {
        // Clear the table first to show loading state
        const tbody = document.getElementById('assets-table-body');
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Loading...</td></tr>';

        const response = await fetch('/api/assets');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        assetsData = data.assets || [];
        console.log('Assets loaded:', assetsData.length, 'assets');

        // Debug: Show first subdomain asset
        const firstSubdomain = assetsData.find(asset => asset.type === 'subdomain');
        if (firstSubdomain) {
            console.log('First subdomain asset:', firstSubdomain);
        }

        document.getElementById('loading-state').style.display = 'none';
        
        if (assetsData.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            document.getElementById('empty-state').classList.add('hidden');
            filterAssets(); // Apply current filters instead of renderAssets() directly
        }
    } catch (error) {
        console.error('Error loading assets:', error);
        document.getElementById('loading-state').innerHTML = `
            <i class="ri-error-warning-line text-2xl text-red-400"></i>
            <p class="text-red-500 mt-2">Error loading assets</p>
        `;
    }
}

// Force refresh assets (clears everything and reloads)
async function forceRefreshAssets() {
    console.log('Force refreshing assets...');

    // Clear all UI elements
    const tbody = document.getElementById('assets-table-body');
    tbody.innerHTML = '';

    // Reset global state
    assetsData = [];

    // Show loading state
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('empty-state').classList.add('hidden');

    // Reload assets
    await loadAssets();
}

// Filter assets
function filterAssets() {
    let filteredAssets = [...assetsData];

    // Filter by asset type
    if (currentAssetType !== 'all') {
        filteredAssets = filteredAssets.filter(asset => asset.type === currentAssetType);
    }

    // Filter by search
    const searchTerm = document.getElementById('asset-search').value.toLowerCase();
    if (searchTerm) {
        filteredAssets = filteredAssets.filter(asset =>
            asset.name.toLowerCase().includes(searchTerm)
        );
    }

    // Filter by status
    const statusFilter = document.getElementById('status-filter').value;
    if (statusFilter) {
        filteredAssets = filteredAssets.filter(asset => {
            if (statusFilter === 'active') return asset.is_active;
            if (statusFilter === 'inactive') return !asset.is_active;
            return true;
        });
    }

    // Filter by risk level
    const riskFilter = document.getElementById('risk-filter').value;
    if (riskFilter) {
        filteredAssets = filteredAssets.filter(asset => asset.risk_level === riskFilter);
    }

    // Filter by tags
    const tagsFilter = document.getElementById('tags-filter').value;
    if (tagsFilter) {
        // Add tags filtering logic here when tags are implemented
    }

    renderAssets(filteredAssets);
}

// Sort assets
function sortAssets() {
    assetsData.sort((a, b) => {
        let aValue = a[currentSort.field] || '';
        let bValue = b[currentSort.field] || '';

        if (typeof aValue === 'string') {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }

        if (currentSort.direction === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
}

// Render assets table
function renderAssets(assets = assetsData) {
    const tbody = document.getElementById('assets-table-body');

    if (assets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    No assets match your current filters
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = assets.map(asset => {
        // Get asset type icon
        const typeIcon = getAssetTypeIcon(asset.type);

        // Get status badge
        const statusBadge = getStatusBadge(asset);

        // Get risk level badge
        const riskBadge = getRiskLevelBadge(asset.risk_level);

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-8 w-8">
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="${typeIcon} text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${asset.name}</div>
                            <div class="text-sm text-gray-500">${asset.description || 'No description'}</div>
                            ${getTechnologiesBadges(asset)}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${asset.type.replace('_', ' ').toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${statusBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${getPortsBubbles(asset.asset_metadata, asset.name)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${riskBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${asset.last_scanned ? new Date(asset.last_scanned).toLocaleDateString() : 'Never'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                    <button class="text-gray-600 hover:text-gray-900 mr-3">Edit</button>
                    <button onclick="confirmDeleteAsset('${asset.id}', '${asset.name}', '${asset.type}')" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

// Helper functions for rendering
function getAssetTypeIcon(type) {
    const icons = {
        'domain': 'ri-global-line',
        'subdomain': 'ri-links-line',
        'ip_address': 'ri-server-line',
        'cloud_resource': 'ri-cloud-line',
        'service': 'ri-apps-line'
    };
    return icons[type] || 'ri-computer-line';
}

function getStatusBadge(asset) {
    // Check for progressive scanning status first
    if (asset.asset_metadata && asset.asset_metadata.scan_status) {
        const scanStatus = asset.asset_metadata.scan_status;

        if (scanStatus === 'scanning') {
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" title="Progressive scanning in progress">
                        <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600 mr-1"></div>
                        Scanning...
                    </span>`;
        } else if (scanStatus === 'http_complete') {
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" title="HTTP probing completed">
                        <i class="ri-global-line mr-1"></i>
                        HTTP Complete
                    </span>`;
        } else if (scanStatus === 'port_complete') {
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800" title="Port scanning completed">
                        <i class="ri-shield-check-line mr-1"></i>
                        Port Complete
                    </span>`;
        }
    }

    // For subdomain assets, show HTTP status code if available
    if (asset.type === 'subdomain' && asset.asset_metadata && asset.asset_metadata.http_probe && asset.asset_metadata.http_probe.status_code) {
        const statusCode = asset.asset_metadata.http_probe.status_code;
        const url = asset.asset_metadata.http_probe.url || '';

        // Color coding based on HTTP status code ranges
        let colorClass = 'bg-gray-100 text-gray-800';
        if (statusCode >= 200 && statusCode < 300) {
            colorClass = 'bg-green-100 text-green-800'; // 2xx Success
        } else if (statusCode >= 300 && statusCode < 400) {
            colorClass = 'bg-yellow-100 text-yellow-800'; // 3xx Redirection
        } else if (statusCode >= 400 && statusCode < 500) {
            colorClass = 'bg-red-100 text-red-800'; // 4xx Client Error
        } else if (statusCode >= 500) {
            colorClass = 'bg-red-100 text-red-800'; // 5xx Server Error
        }

        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}" title="HTTP ${statusCode} - ${url}">
                    ${statusCode}
                </span>`;
    }

    // For other assets or when no HTTP probe data, show active/inactive status
    if (asset.is_active) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>';
    } else {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Inactive</span>';
    }
}

function getTechnologiesBadges(asset) {
    // For subdomain and domain assets, show detected technologies if available
    if ((asset.type === 'subdomain' || asset.type === 'domain') && asset.asset_metadata && asset.asset_metadata.http_probe) {
        // Check for technologies in 'tech' field (from httpx)
        let technologies = asset.asset_metadata.http_probe.tech || asset.asset_metadata.http_probe.technologies || [];

        // Also check for webserver information
        const webserver = asset.asset_metadata.http_probe.webserver;
        if (webserver && !technologies.includes(webserver)) {
            technologies = [webserver, ...technologies];
        }

        if (Array.isArray(technologies) && technologies.length > 0) {
            // Show first 4 technologies, then "+" indicator if more
            const maxVisible = 4;
            const visibleTech = technologies.slice(0, maxVisible);
            const remainingCount = technologies.length - maxVisible;

            let html = '<div class="flex flex-wrap gap-1 mt-1">';

            visibleTech.forEach(tech => {
                // Get technology-specific styling
                const techStyle = getTechnologyStyle(tech);
                html += `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${techStyle.class}" title="Detected technology: ${tech}">
                            <i class="${techStyle.icon} mr-1"></i>${tech}
                         </span>`;
            });

            if (remainingCount > 0) {
                const allTechTitle = technologies.join(', ');
                html += `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-50 text-gray-600 border border-gray-200 cursor-pointer hover:bg-gray-100" title="All technologies: ${allTechTitle}" onclick="showTechnologiesModal('${asset.name}', ${JSON.stringify(technologies).replace(/"/g, '&quot;')})">
                            <i class="ri-more-line mr-1"></i>+${remainingCount}
                         </span>`;
            }

            html += '</div>';
            return html;
        }
    }

    return '';
}

function getTechnologyStyle(tech) {
    const techLower = tech.toLowerCase();

    // Web servers
    if (techLower.includes('apache')) {
        return { class: 'bg-red-50 text-red-700 border border-red-200', icon: 'ri-server-line' };
    } else if (techLower.includes('nginx')) {
        return { class: 'bg-green-50 text-green-700 border border-green-200', icon: 'ri-server-line' };
    } else if (techLower.includes('iis') || techLower.includes('microsoft')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-microsoft-line' };
    }

    // Programming languages
    else if (techLower.includes('php')) {
        return { class: 'bg-purple-50 text-purple-700 border border-purple-200', icon: 'ri-code-line' };
    } else if (techLower.includes('python') || techLower.includes('django') || techLower.includes('flask')) {
        return { class: 'bg-yellow-50 text-yellow-700 border border-yellow-200', icon: 'ri-code-line' };
    } else if (techLower.includes('node') || techLower.includes('javascript') || techLower.includes('react') || techLower.includes('vue') || techLower.includes('angular')) {
        return { class: 'bg-green-50 text-green-700 border border-green-200', icon: 'ri-javascript-line' };
    } else if (techLower.includes('java') || techLower.includes('spring')) {
        return { class: 'bg-orange-50 text-orange-700 border border-orange-200', icon: 'ri-code-line' };
    }

    // Frameworks and CMS
    else if (techLower.includes('wordpress')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-wordpress-line' };
    } else if (techLower.includes('drupal')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-code-s-slash-line' };
    } else if (techLower.includes('joomla')) {
        return { class: 'bg-orange-50 text-orange-700 border border-orange-200', icon: 'ri-code-s-slash-line' };
    }

    // Cloud and CDN
    else if (techLower.includes('cloudflare')) {
        return { class: 'bg-orange-50 text-orange-700 border border-orange-200', icon: 'ri-cloud-line' };
    } else if (techLower.includes('aws') || techLower.includes('amazon')) {
        return { class: 'bg-yellow-50 text-yellow-700 border border-yellow-200', icon: 'ri-cloud-line' };
    } else if (techLower.includes('google') || techLower.includes('gcp')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-cloud-line' };
    }

    // Databases
    else if (techLower.includes('mysql') || techLower.includes('mariadb')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-database-line' };
    } else if (techLower.includes('postgresql') || techLower.includes('postgres')) {
        return { class: 'bg-blue-50 text-blue-700 border border-blue-200', icon: 'ri-database-line' };
    } else if (techLower.includes('mongodb')) {
        return { class: 'bg-green-50 text-green-700 border border-green-200', icon: 'ri-database-line' };
    }

    // Default styling
    return { class: 'bg-gray-50 text-gray-700 border border-gray-200', icon: 'ri-code-box-line' };
}

function getRiskLevelBadge(riskLevel) {
    const badges = {
        'critical': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Critical</span>',
        'high': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">High</span>',
        'medium': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Medium</span>',
        'low': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Low</span>',
        'none': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">None</span>'
    };
    return badges[riskLevel] || badges['none'];
}

function getPortsBubbles(assetMetadata, assetName) {
    if (!assetMetadata || !assetMetadata.ports || !Array.isArray(assetMetadata.ports)) {
        return '<span class="text-gray-400 text-xs">No ports scanned</span>';
    }

    const ports = assetMetadata.ports;
    if (ports.length === 0) {
        return '<span class="text-gray-400 text-xs">No open ports</span>';
    }

    // Show first 3 ports as bubbles, then "+" indicator if more
    const maxVisible = 3;
    const visiblePorts = ports.slice(0, maxVisible);
    const remainingCount = ports.length - maxVisible;

    let html = '<div class="flex flex-wrap gap-1">';

    // Add port bubbles
    visiblePorts.forEach(portInfo => {
        const port = portInfo.port;
        const service = portInfo.service || '';
        const title = service ? `${port}/${service}` : port;

        // Color coding based on common ports
        let colorClass = 'bg-blue-100 text-blue-800';
        if (['80', '443', '8080', '8443'].includes(port.toString())) {
            colorClass = 'bg-green-100 text-green-800'; // Web services
        } else if (['22', '23', '3389'].includes(port.toString())) {
            colorClass = 'bg-orange-100 text-orange-800'; // Remote access
        } else if (['21', '25', '53', '110', '143', '993', '995'].includes(port.toString())) {
            colorClass = 'bg-purple-100 text-purple-800'; // Network services
        }

        html += `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${colorClass}" title="${title}">
                    ${port}
                 </span>`;
    });

    // Add "+" indicator if there are more ports
    if (remainingCount > 0) {
        const escapedAssetName = (assetName || 'Asset').replace(/'/g, "\\'");
        const portsDataAttr = `data-ports='${JSON.stringify(ports)}'`;
        html += `<span onclick="showAllPortsModalFromElement(this, '${escapedAssetName}')" ${portsDataAttr} class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 cursor-pointer hover:bg-gray-200" title="Click to see all ${ports.length} ports">
                    +${remainingCount}
                 </span>`;
    }

    html += '</div>';
    return html;
}

// Modal functionality
function initializeModals() {
    // Add Asset button click handlers
    document.getElementById('add-asset-btn').addEventListener('click', showAddAssetModal);
    document.getElementById('empty-add-asset-btn').addEventListener('click', showAddAssetModal);

    // Modal close handlers
    document.getElementById('close-modal').addEventListener('click', hideAddAssetModal);
    document.getElementById('add-asset-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideAddAssetModal();
        }
    });

    // Start scan from Add Asset modal
    document.getElementById('start-add-asset-scan').addEventListener('click', startAddAssetScan);

    // Progress section buttons for Add Asset modal
    document.getElementById('view-assets-during-add-asset-scan').addEventListener('click', function() {
        hideAddAssetModal();
        loadAssets();
    });

    document.getElementById('stop-add-asset-scan').addEventListener('click', stopAddAssetScan);

    // Results section buttons for Add Asset modal
    document.getElementById('close-add-asset-results').addEventListener('click', hideAddAssetModal);
    document.getElementById('view-discovered-add-asset-assets').addEventListener('click', function() {
        hideAddAssetModal();
        loadAssets();
    });
}

function showAddAssetModal() {
    document.getElementById('add-asset-modal').classList.remove('hidden');

    // Reset modal to initial state
    document.getElementById('add-asset-scan-config-section').classList.remove('hidden');
    document.getElementById('add-asset-progress-section').classList.add('hidden');
    document.getElementById('add-asset-results-section').classList.add('hidden');

    // Clear form fields
    document.getElementById('add-asset-domain-input').value = '';
    document.getElementById('add-asset-scan-type').value = 'quick';

    // Reset progress indicators
    resetAddAssetProgress();
}

function hideAddAssetModal() {
    document.getElementById('add-asset-modal').classList.add('hidden');

    // Close any active event source for add asset modal
    if (addAssetEventSource) {
        addAssetEventSource.close();
        addAssetEventSource = null;
    }

    addAssetScanActive = false;
}

// Scanning functionality
function initializeScanning() {
    // Scanning functionality is now integrated into the Add Asset modal
}

// Utility functions for notifications
function showSuccess(message) {
    // Create a simple success notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = `<i class="ri-check-line mr-2"></i>${message}`;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showError(message) {
    // Create a simple error notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = `<i class="ri-error-warning-line mr-2"></i>${message}`;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// All Ports Modal Functions
function showAllPortsModal(assetName, ports) {
    const modal = document.getElementById('all-ports-modal');
    const title = document.getElementById('ports-modal-title');
    const portsList = document.getElementById('all-ports-list');

    title.textContent = `All Ports for ${assetName}`;

    // Generate ports list HTML
    portsList.innerHTML = ports.map(portInfo => {
        const port = portInfo.port;
        const service = portInfo.service || 'Unknown';

        // Color coding based on common ports
        let colorClass = 'bg-blue-100 text-blue-800';
        if (['80', '443', '8080', '8443'].includes(port.toString())) {
            colorClass = 'bg-green-100 text-green-800'; // Web services
        } else if (['22', '23', '3389'].includes(port.toString())) {
            colorClass = 'bg-orange-100 text-orange-800'; // Remote access
        } else if (['21', '25', '53', '110', '143', '993', '995'].includes(port.toString())) {
            colorClass = 'bg-purple-100 text-purple-800'; // Network services
        }

        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${colorClass}">
                        ${port}
                    </span>
                    <span class="text-sm text-gray-600">${service}</span>
                </div>
                <span class="text-xs text-gray-400">Port ${port}</span>
            </div>
        `;
    }).join('');

    modal.classList.remove('hidden');
}

function hideAllPortsModal() {
    document.getElementById('all-ports-modal').classList.add('hidden');
}

function showAllPortsModalFromElement(element, assetName) {
    const portsData = JSON.parse(element.getAttribute('data-ports'));
    showAllPortsModal(assetName, portsData);
}

// Technologies Modal Functions
function showTechnologiesModal(assetName, technologies) {
    const modal = document.getElementById('all-technologies-modal');
    const title = document.getElementById('technologies-modal-title');
    const techList = document.getElementById('all-technologies-list');

    title.textContent = `Technologies for ${assetName}`;

    // Generate technologies list HTML
    techList.innerHTML = technologies.map(tech => {
        const techStyle = getTechnologyStyle(tech);

        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${techStyle.class}">
                        <i class="${techStyle.icon} mr-2"></i>${tech}
                    </span>
                </div>
                <span class="text-xs text-gray-400">Detected Technology</span>
            </div>
        `;
    }).join('');

    modal.classList.remove('hidden');
}

function hideTechnologiesModal() {
    document.getElementById('all-technologies-modal').classList.add('hidden');
}

// ============================================================================
// PROGRESSIVE SCANNING NOTIFICATION MANAGEMENT
// ============================================================================

function showProgressiveNotification() {
    // Show progressive scanning notification banner
    const notification = document.getElementById('progressive-scanning-notification');
    if (notification) {
        notification.classList.remove('hidden');

        // Add event handler for view progress button if not already added
        const viewProgressBtn = document.getElementById('view-scan-progress');
        if (viewProgressBtn && !viewProgressBtn.hasAttribute('data-handler-added')) {
            viewProgressBtn.addEventListener('click', function() {
                if (addAssetScanActive) {
                    showAddAssetModal();
                }
            });
            viewProgressBtn.setAttribute('data-handler-added', 'true');
        }
    }
}

function hideProgressiveNotification() {
    // Hide progressive scanning notification banner
    const notification = document.getElementById('progressive-scanning-notification');
    if (notification) {
        notification.classList.add('hidden');
    }
}

function updateProgressiveNotificationStats(subdomains, assets, updates) {
    // Update the stats in the notification banner
    const subdomainsEl = document.getElementById('notification-subdomains');
    const assetsEl = document.getElementById('notification-assets');
    const updatesEl = document.getElementById('notification-updates');

    if (subdomainsEl) subdomainsEl.textContent = subdomains || 0;
    if (assetsEl) assetsEl.textContent = assets || 0;
    if (updatesEl) updatesEl.textContent = updates || 0;
}

// ============================================================================
// REAL-TIME ASSET UPDATES FOR PROGRESSIVE SCANNING
// ============================================================================

// Check for progressive scanning activity and auto-refresh assets
function checkForProgressiveScanning() {
    // Check if there are any assets with scanning status or active scanning sessions
    const scanningAssets = assetsData.filter(asset =>
        asset.asset_metadata && asset.asset_metadata.scan_status === 'scanning'
    );

    const hasActiveScanning = addAssetScanActive;

    if (scanningAssets.length > 0 || hasActiveScanning) {
        showProgressiveNotification();
        // Auto-refresh assets every 5 seconds during progressive scanning
        setTimeout(() => {
            loadAssets();
            checkForProgressiveScanning();
        }, 5000);
    } else {
        hideProgressiveNotification();
    }
}

// Enhanced loadAssets function to detect progressive scanning
function loadAssetsWithProgressiveDetection() {
    loadAssets().then(() => {
        checkForProgressiveScanning();
    });
}

// Auto-refresh assets when page becomes visible (for real-time updates)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        loadAssetsWithProgressiveDetection();
    }
});

// Check for progressive scanning on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initial check after assets are loaded
    setTimeout(checkForProgressiveScanning, 2000);
});

// Delete Confirmation Modal Functions
let assetToDelete = null;

function confirmDeleteAsset(assetId, assetName, assetType) {
    console.log('confirmDeleteAsset called with:', { assetId, assetName, assetType });

    const modal = document.getElementById('delete-confirmation-modal');
    const message = document.getElementById('delete-confirmation-message');
    const warning = document.getElementById('delete-warning-message');

    assetToDelete = { id: assetId, name: assetName, type: assetType };
    console.log('assetToDelete set to:', assetToDelete);

    message.textContent = `Are you sure you want to delete "${assetName}"?`;

    // Show different warnings based on asset type
    if (assetType === 'domain') {
        warning.innerHTML = `
            <strong>Warning:</strong> Deleting this domain will also remove all associated subdomains and their scan results. This action cannot be undone.
        `;
    } else {
        warning.textContent = 'This action cannot be undone.';
    }

    modal.classList.remove('hidden');
}

function hideDeleteConfirmationModal() {
    document.getElementById('delete-confirmation-modal').classList.add('hidden');
    assetToDelete = null;
}

async function executeDelete() {
    console.log('executeDelete called, assetToDelete:', assetToDelete);

    if (!assetToDelete) {
        console.error('assetToDelete is null or undefined');
        showError('No asset selected for deletion');
        return;
    }

    try {
        const response = await fetch(`/api/assets/${assetToDelete.id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            const deletedAssetName = assetToDelete.name;
            hideDeleteConfirmationModal();
            showSuccess(`Asset "${deletedAssetName}" deleted successfully`);

            // Refresh the assets list
            console.log('Refreshing assets list after deletion');

            // Show loading state briefly
            document.getElementById('loading-state').style.display = 'block';

            // Add a small delay to ensure backend processing is complete
            setTimeout(async () => {
                // Force a complete refresh
                await forceRefreshAssets();
                console.log('Assets list refreshed, new count:', assetsData.length);
            }, 500);
        } else {
            throw new Error(result.error || 'Failed to delete asset');
        }

    } catch (error) {
        console.error('Delete error:', error);
        showError(`Failed to delete asset: ${error.message}`);
    }
}







// ============================================================================
// ADD ASSET MODAL SCANNING FUNCTIONALITY
// ============================================================================

function resetAddAssetProgress() {
    document.getElementById('add-asset-progress-bar').style.width = '0%';
    document.getElementById('add-asset-current-stage').textContent = 'Initializing scan...';
    document.getElementById('add-asset-subdomains-found').textContent = '0';
    document.getElementById('add-asset-assets-stored').textContent = '0';
    document.getElementById('add-asset-progressive-updates').textContent = '0';
    document.getElementById('add-asset-scan-log').innerHTML = '';
    addAssetUpdateCount = 0;
}

async function startAddAssetScan() {
    const domain = document.getElementById('add-asset-domain-input').value.trim();
    const scanType = document.getElementById('add-asset-scan-type').value;

    if (!domain) {
        showError('Please enter a domain to scan');
        return;
    }

    // Validate domain format
    const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])*$/;
    if (!domainRegex.test(domain)) {
        showError('Please enter a valid domain name');
        return;
    }

    try {
        // Show progress section
        document.getElementById('add-asset-scan-config-section').classList.add('hidden');
        document.getElementById('add-asset-progress-section').classList.remove('hidden');

        addAssetScanActive = true;
        resetAddAssetProgress();

        addAddAssetLogEntry('Starting large-scale progressive scan...', 'info');

        // Start the progressive scan
        const response = await fetch('/api/large-scale-scan-progressive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                domain: domain,
                scan_type: scanType
            })
        });

        const data = await response.json();

        if (data.success) {
            addAssetScanTaskId = data.task_id;
            document.getElementById('add-asset-task-id').textContent = `Task ID: ${data.task_id}`;

            addAddAssetLogEntry(`Scan initiated successfully (Task: ${data.task_id})`, 'success');

            // Start Server-Sent Events for real-time updates
            startAddAssetProgressiveUpdates(data.progressive_updates_url);
        } else {
            throw new Error(data.error || 'Failed to start progressive scan');
        }
    } catch (error) {
        console.error('Add Asset scan error:', error);
        addAddAssetLogEntry(`Scan failed: ${error.message}`, 'error');
        showError('Failed to start scan: ' + error.message);

        // Return to config section
        document.getElementById('add-asset-progress-section').classList.add('hidden');
        document.getElementById('add-asset-scan-config-section').classList.remove('hidden');
        addAssetScanActive = false;
    }
}

function startAddAssetProgressiveUpdates(updatesUrl) {
    if (addAssetEventSource) {
        addAssetEventSource.close();
    }

    addAssetEventSource = new EventSource(updatesUrl);

    addAssetEventSource.onopen = function(event) {
        console.log('Add Asset SSE connection opened');
        addAddAssetLogEntry('Connected to real-time updates', 'info');
    };

    addAssetEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            handleAddAssetProgressUpdate(data);
        } catch (error) {
            console.error('Error parsing Add Asset SSE data:', error);
        }
    };

    addAssetEventSource.onerror = function(event) {
        console.error('Add Asset SSE error:', event);
        addAddAssetLogEntry('Connection error, retrying...', 'warning');
    };
}

function handleAddAssetProgressUpdate(data) {
    addAssetUpdateCount++;
    document.getElementById('add-asset-progressive-updates').textContent = addAssetUpdateCount;

    console.log('Add Asset progress update:', data);

    switch (data.type) {
        case 'connected':
            addAddAssetLogEntry('Real-time updates connected', 'success');
            break;

        case 'progress':
            updateAddAssetProgress(data);
            break;

        case 'progressive_update':
            handleAddAssetProgressiveUpdate(data.update);
            break;

        case 'completed':
            handleAddAssetScanCompletion(data);
            break;

        case 'error':
            addAddAssetLogEntry(`Error: ${data.error}`, 'error');
            showError('Scan error: ' + data.error);
            break;

        case 'timeout':
            addAddAssetLogEntry('Scan timeout - check assets page for results', 'warning');
            break;
    }
}

function updateAddAssetProgress(data) {
    const progress = data.progress || 0;
    const stage = data.stage || 'Unknown';
    const message = data.message || 'Processing...';

    // Update progress bar
    document.getElementById('add-asset-progress-bar').style.width = progress + '%';

    // Update current stage
    document.getElementById('add-asset-current-stage').textContent = message;

    // Add log entry
    addAddAssetLogEntry(`${stage}: ${message}`, 'info');
}

function handleAddAssetProgressiveUpdate(update) {
    if (update.type === 'subdomains_discovered') {
        const count = update.count || 0;
        document.getElementById('add-asset-subdomains-found').textContent = count;
        addAddAssetLogEntry(`Discovered ${count} subdomains`, 'success');

        // Update notification banner
        updateProgressiveNotificationStats(count, null, addAssetUpdateCount);
        showProgressiveNotification();
    } else if (update.type === 'subdomains_stored') {
        const storedCount = update.stored_count || 0;
        document.getElementById('add-asset-assets-stored').textContent = storedCount;
        addAddAssetLogEntry(`Stored ${storedCount} assets in database`, 'success');

        // Update notification banner
        const subdomainsCount = document.getElementById('add-asset-subdomains-found').textContent;
        updateProgressiveNotificationStats(subdomainsCount, storedCount, addAssetUpdateCount);

        // Refresh assets in background
        loadAssets();
    } else if (update.type === 'http_probing_complete') {
        addAddAssetLogEntry('HTTP probing completed', 'info');
    } else if (update.type === 'port_scanning_complete') {
        addAddAssetLogEntry('Port scanning completed', 'info');
    }
}

function handleAddAssetScanCompletion(data) {
    addAddAssetLogEntry('Progressive scan completed successfully!', 'success');

    // Close SSE connection
    if (addAssetEventSource) {
        addAssetEventSource.close();
        addAssetEventSource = null;
    }

    addAssetScanActive = false;

    // Hide progressive notification
    hideProgressiveNotification();

    // Show results section
    document.getElementById('add-asset-progress-section').classList.add('hidden');
    document.getElementById('add-asset-results-section').classList.remove('hidden');

    // Populate scan summary
    const summary = data.result || {};
    const summaryHtml = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h5 class="font-medium text-green-900 mb-2">Scan Summary</h5>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-green-700">Subdomains Found:</span>
                    <span class="font-medium">${summary.subdomains_found || 0}</span>
                </div>
                <div>
                    <span class="text-green-700">Assets Stored:</span>
                    <span class="font-medium">${summary.assets_stored || 0}</span>
                </div>
                <div>
                    <span class="text-green-700">HTTP Services:</span>
                    <span class="font-medium">${summary.http_services || 0}</span>
                </div>
                <div>
                    <span class="text-green-700">Open Ports:</span>
                    <span class="font-medium">${summary.open_ports || 0}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('add-asset-scan-summary').innerHTML = summaryHtml;

    // Refresh assets to show all discovered items
    loadAssets();
}

function stopAddAssetScan() {
    if (addAssetEventSource) {
        addAssetEventSource.close();
        addAssetEventSource = null;
    }

    addAssetScanActive = false;
    addAddAssetLogEntry('Scan stopped by user', 'warning');

    // Hide progressive notification
    hideProgressiveNotification();

    // Return to config section
    document.getElementById('add-asset-progress-section').classList.add('hidden');
    document.getElementById('add-asset-scan-config-section').classList.remove('hidden');
}

function addAddAssetLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('add-asset-scan-log');
    const timestamp = new Date().toLocaleTimeString();

    let iconClass = 'ri-information-line';
    let colorClass = 'text-gray-600';

    switch (type) {
        case 'success':
            iconClass = 'ri-check-line';
            colorClass = 'text-green-600';
            break;
        case 'error':
            iconClass = 'ri-error-warning-line';
            colorClass = 'text-red-600';
            break;
        case 'warning':
            iconClass = 'ri-alert-line';
            colorClass = 'text-yellow-600';
            break;
    }

    const logEntry = document.createElement('div');
    logEntry.className = `flex items-start space-x-2 ${colorClass}`;
    logEntry.innerHTML = `
        <i class="${iconClass} mt-0.5"></i>
        <span class="text-xs text-gray-500">${timestamp}</span>
        <span class="flex-1">${message}</span>
    `;

    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}
</script>
{% endblock %}
