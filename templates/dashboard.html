{% extends "base.html" %}

{% block title %}Dashboard - Attack Surface Management{% endblock %}

{% block content %}
<!-- Mobile sidebar overlay -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<div class="flex min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-slate-900 border-r border-slate-800 flex flex-col text-white transition-all duration-300 ease-in-out w-16">
        <!-- Logo Section -->
        <div class="flex items-center justify-center py-6 mb-6">
            <!-- Expanded text only -->
            <div id="logo-expanded" class="opacity-0 transition-opacity duration-300 flex items-center justify-center w-full px-4">
                <span class="text-white font-bold text-lg whitespace-nowrap">AttackSurfacePro</span>
            </div>
        </div>

        <!-- Navigation Items -->
        <nav class="flex-1 px-2">
            <!-- Dashboard -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors bg-slate-700 relative" data-section="dashboard" title="Dashboard">
                <div class="flex items-center">
                    <i class="ri-dashboard-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Dashboard</span>
                </div>
            </div>

            <!-- Assets -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" data-section="assets" title="Assets">
                <div class="flex items-center">
                    <i class="ri-computer-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Assets</span>
                </div>
            </div>

            <!-- Vulnerabilities -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/vulnerabilities'" title="Vulnerabilities">
                <div class="flex items-center">
                    <i class="ri-bug-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Vulnerabilities</span>
                </div>
            </div>

            <!-- Technologies -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/technologies'" title="Technology Discovery">
                <div class="flex items-center">
                    <i class="ri-stack-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Technologies</span>
                </div>
            </div>

            <!-- Graph -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/graph'" title="Network Graph">
                <div class="flex items-center">
                    <i class="ri-node-tree ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Graph</span>
                </div>
            </div>

            <!-- Reports -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/reports'" title="Reports">
                <div class="flex items-center">
                    <i class="ri-file-chart-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Reports</span>
                </div>
            </div>

            <!-- Settings -->
            {% if can_manage_settings() %}
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/settings'" title="Settings">
                <div class="flex items-center">
                    <i class="ri-settings-3-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Settings</span>
                </div>
            </div>
            {% endif %}
        </nav>

        <!-- Toggle Button -->
        <div class="p-2">
            <button id="sidebar-toggle" class="w-full p-3 rounded-lg hover:bg-slate-700 transition-colors flex items-center justify-center" title="Toggle Sidebar">
                <i class="ri-menu-line ri-lg min-w-[24px]"></i>
                <span id="toggle-text" class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Expand</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-4 md:px-6 mobile-header">
            <div class="flex items-center">
                <!-- Mobile menu button -->
                <button id="mobile-menu-btn" class="mobile-menu-btn mr-3 md:hidden flex items-center justify-center touch-target">
                    <i class="ri-menu-line ri-lg"></i>
                </button>

                <h1 class="text-lg md:text-xl font-bold mr-4 md:mr-8 responsive-text-xl">{{ current_user.username.upper() }}</h1>

                <!-- Desktop filter dropdown - hidden on mobile -->
                <div class="relative hidden md:block">
                    <button class="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-button text-sm touch-target">
                        All assets
                        <i class="ri-arrow-down-s-line"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <!-- Help button - hidden on small mobile -->
                <div class="hidden sm:flex w-10 h-10 items-center justify-center rounded-full bg-slate-800 cursor-pointer touch-target">
                    <i class="ri-question-line"></i>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-sm hidden sm:inline">User</span>
                    <div class="w-10 h-10 flex items-center justify-center rounded-full bg-purple-500 cursor-pointer touch-target">
                        <span class="text-white font-medium">{{ current_user.username[0].upper() }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="flex-1 overflow-auto p-4 md:p-6 lg:p-8">
            <!-- Title -->
            <div class="mb-4 md:mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold responsive-text-2xl">Overview</h1>
                    <p class="text-slate-400 text-sm mt-1 mobile-text-sm">Attack Surface Discovery | Real-time Monitoring</p>
                </div>
                <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                    <button class="flex items-center gap-2 text-xs md:text-sm text-slate-400 touch-target">
                        <i class="ri-time-line"></i>
                        <span class="hidden sm:inline">Re-run your scan to see this data</span>
                        <span class="sm:hidden">Re-run scan</span>
                    </button>
                    <button class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-green-500/10 text-green-400 touch-target">
                        <i class="ri-check-line"></i>
                    </button>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="h-32 md:h-48 mb-6 md:mb-8 wave-bg rounded-lg bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 mobile-chart-sm">
                <div id="timeline-chart" class="w-full h-full chart-container"></div>
            </div>

            <!-- Filters -->
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-6 md:mb-8 gap-4">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 md:gap-4">
                    <div class="relative w-full sm:w-auto">
                        <button class="flex items-center justify-between w-full sm:w-56 bg-slate-800 px-4 py-2 rounded-button text-sm touch-target">
                            <span>All Assets</span>
                            <i class="ri-arrow-down-s-line"></i>
                        </button>
                    </div>
                    <div class="flex w-full sm:w-auto">
                        <button class="flex-1 sm:flex-none px-3 md:px-4 py-2 bg-slate-800 rounded-l-button text-sm border-r border-slate-700 touch-target">Score</button>
                        <button class="flex-1 sm:flex-none px-3 md:px-4 py-2 bg-slate-900 rounded-r-button text-sm touch-target">All issues</button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <span class="text-sm text-slate-400 mobile-text-sm hidden sm:inline">Quick filter</span>
                    <div class="flex items-center gap-2 flex-wrap">
                        <div class="px-2 md:px-3 py-1 bg-red-900/30 text-red-400 rounded-full text-xs mobile-text-xs">
                            Critical {{ critical_vulns }}
                        </div>
                        <div class="px-2 md:px-3 py-1 bg-amber-900/30 text-amber-400 rounded-full text-xs mobile-text-xs">
                            High {{ asset_counts.subdomains }}
                        </div>
                        <div class="px-2 md:px-3 py-1 bg-green-900/30 text-green-400 rounded-full text-xs mobile-text-xs">
                            Secure {{ total_assets }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discovery Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                <div class="lg:col-span-1 bg-slate-800/50 rounded-lg p-4 md:p-6 mobile-p-4 card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium responsive-text-lg">Discovery</h2>
                        <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700/50 touch-target">
                            <i class="ri-information-line text-slate-400"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-3 md:gap-4 mobile-grid-2">
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Sites</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold responsive-text-2xl">{{ total_assets }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">monitored</span>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Domains</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold responsive-text-2xl">{{ asset_counts.domains }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">active</span>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Subdomains</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold responsive-text-2xl">{{ asset_counts.subdomains }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">found</span>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Services</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold responsive-text-2xl">{{ asset_counts.ip_addresses }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">running</span>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Cloud</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold responsive-text-2xl">{{ asset_counts.cloud_resources }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">resources</span>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-3 md:p-4 mobile-p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-400 mobile-text-sm">Risks</span>
                                <i class="ri-arrow-right-line text-slate-400"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-xl md:text-2xl font-bold text-red-400 responsive-text-2xl">{{ critical_vulns }}</span>
                                <span class="text-xs text-slate-400 mobile-text-xs">critical</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-slate-800/50 rounded-lg p-4 md:p-6 mobile-p-4 card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium responsive-text-lg">Checks</h2>
                        <div class="flex items-center gap-2">
                            <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700/50 touch-target">
                                <i class="ri-expand-left-line text-slate-400"></i>
                            </button>
                            <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700/50 touch-target">
                                <i class="ri-information-line text-slate-400"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3 md:space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="ri-error-warning-line text-red-400"></i>
                                <span class="text-sm mobile-text-sm">Vulnerability Scan</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                <i class="ri-arrow-down-s-line text-slate-400"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="ri-error-warning-line text-green-400"></i>
                                <span class="text-sm mobile-text-sm">Port Scanning</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <i class="ri-arrow-down-s-line text-slate-400"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="ri-shield-check-line text-slate-400"></i>
                                <span class="text-sm mobile-text-sm">Subdomain Discovery</span>
                            </div>
                            <i class="ri-arrow-down-s-line text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-slate-800/50 rounded-lg p-4 md:p-6 mobile-p-4 card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium responsive-text-lg">Visualization</h2>
                        <button id="refresh-visualization" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700/50 touch-target">
                            <i class="ri-refresh-line text-slate-400"></i>
                        </button>
                    </div>

                    <!-- Network Visualization Container -->
                    <div class="relative">
                        <div id="network-visualization" class="w-full h-64 bg-slate-900 rounded-lg border border-slate-700 relative overflow-hidden">
                            <!-- Loading state -->
                            <div id="viz-loading" class="absolute inset-0 flex items-center justify-center">
                                <div class="text-slate-400 text-sm">Loading network map...</div>
                            </div>

                            <!-- Cytoscape container -->
                            <div id="cy-dashboard" class="w-full h-full"></div>
                        </div>

                        <!-- Legend -->
                        <div id="viz-legend" class="absolute top-2 left-2 bg-slate-800/90 backdrop-blur-sm rounded-lg p-2 text-xs z-10 hidden">
                            <div class="flex items-center mb-1">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <span class="text-slate-300">Domain</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-slate-300">Subdomain</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <div class="w-2 h-2 bg-amber-500 rounded-full mr-2"></div>
                                <span class="text-slate-300">Technology</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                <span class="text-slate-300">Vulnerability</span>
                            </div>
                        </div>

                        <!-- Stats overlay -->
                        <div id="viz-stats" class="absolute bottom-2 right-2 bg-slate-800/90 backdrop-blur-sm rounded-lg p-2 text-xs text-slate-300 hidden">
                            <div id="viz-node-count">Nodes: 0</div>
                            <div id="viz-edge-count">Edges: 0</div>
                        </div>
                    </div>

                    <!-- Tooltip -->
                    <div id="viz-tooltip" class="absolute bg-slate-800 text-white p-2 rounded-lg text-xs pointer-events-none z-20 hidden shadow-lg border border-slate-600">
                        <div id="tooltip-content"></div>
                    </div>
                </div>
            </div>

            <!-- Current Issues Section -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 md:gap-6 mb-6">
                <!-- Left Section - Score and Results -->
                <div class="xl:col-span-1 space-y-4 md:space-y-6">
                    <!-- Score Card -->
                    <div class="card rounded-lg p-4 md:p-6 mobile-p-4 flex flex-col items-center">
                        <div class="relative w-32 h-32 md:w-40 md:h-40 flex items-center justify-center mb-4">
                            <svg class="progress-ring" width="100%" height="100%" viewBox="0 0 160 160">
                                <circle class="progress-ring-circle" stroke="#1e293b" stroke-width="8" fill="transparent" r="70" cx="80" cy="80"/>
                                <circle class="progress-ring-circle" stroke="#4ade80" stroke-width="8" fill="transparent" r="70" cx="80" cy="80" stroke-dashoffset="60"/>
                            </svg>
                            <div class="absolute flex flex-col items-center">
                                <span class="text-xs text-slate-400 mobile-text-xs">Security Score</span>
                                <div class="flex items-end">
                                    <span class="text-3xl md:text-5xl font-bold responsive-text-4xl">8.3</span>
                                    <span class="text-green-400 text-sm ml-1">+0.2</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Results Card -->
                    <div class="card rounded-lg p-4 md:p-6 mobile-p-4">
                        <h3 class="text-lg font-medium mb-4 responsive-text-lg">Results for last week</h3>
                        <!-- Issues Found -->
                        <div class="mb-4 md:mb-6">
                            <h4 class="text-sm text-slate-400 mb-2 mobile-text-sm">Issues found</h4>
                            <div class="space-y-3">
                                <div class="flex">
                                    <div class="w-1 bg-red-500 mr-3"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm text-slate-400 mobile-text-sm">Critical</span>
                                            <span class="font-medium">{{ critical_vulns }}</span>
                                        </div>
                                        <div class="h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-red-500 rounded-full" style="width: {% if critical_vulns > 0 %}80{% else %}0{% endif %}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex">
                                    <div class="w-1 bg-amber-500 mr-3"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm text-slate-400 mobile-text-sm">High</span>
                                            <span class="font-medium">{{ active_alerts }}</span>
                                        </div>
                                        <div class="h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-amber-500 rounded-full" style="width: {% if active_alerts > 0 %}60{% else %}0{% endif %}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Discovered Assets -->
                        <div>
                            <h4 class="text-sm text-slate-400 mb-2 mobile-text-sm">Discovered assets <span class="text-xs text-slate-500 mobile-text-xs hidden sm:inline">detected automatically</span></h4>
                            <div class="space-y-3">
                                <div class="flex">
                                    <div class="w-1 bg-indigo-500 mr-3"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-slate-400 mobile-text-sm">Domains</span>
                                            <span class="font-medium">{{ asset_counts.domains }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex">
                                    <div class="w-1 bg-indigo-500 mr-3"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-slate-400 mobile-text-sm">Subdomains</span>
                                            <span class="font-medium">{{ asset_counts.subdomains }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Section - Current Issues -->
                <div class="xl:col-span-2">
                    <h2 class="text-xl font-medium mb-4 responsive-text-xl">Current issues</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-2 gap-4 md:gap-6 mobile-grid-1">
                        <!-- Vulnerabilities Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-red-900/40 to-red-800/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-red-400 mb-1 responsive-text-4xl">{{ critical_vulns }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Critical Vulnerabilities</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-red-900/50 text-red-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ critical_vulns }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Network Security Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-amber-900/40 to-amber-800/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-amber-400 mb-1 responsive-text-4xl">{{ asset_counts.ip_addresses }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Network assets</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-amber-900/50 text-amber-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ asset_counts.ip_addresses }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Subdomain Security Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-amber-800/40 to-amber-700/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-amber-300 mb-1 responsive-text-4xl">{{ asset_counts.subdomains }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Subdomains</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-amber-900/50 text-amber-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ asset_counts.subdomains }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Cloud Resources Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-blue-900/40 to-blue-800/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-blue-400 mb-1 responsive-text-4xl">{{ asset_counts.cloud_resources }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Cloud resources</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-blue-900/50 text-blue-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ asset_counts.cloud_resources }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Active Alerts Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-indigo-900/40 to-indigo-800/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-indigo-400 mb-1 responsive-text-4xl">{{ active_alerts }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Active alerts</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-indigo-900/50 text-indigo-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ active_alerts }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Total Assets Card -->
                        <div class="card rounded-lg p-4 md:p-6 mobile-p-4 bg-gradient-to-br from-green-900/40 to-green-800/10">
                            <div class="flex flex-col h-full min-h-[120px]">
                                <div class="mb-auto">
                                    <h3 class="text-2xl md:text-4xl font-bold text-green-400 mb-1 responsive-text-4xl">{{ total_assets }}</h3>
                                    <p class="text-slate-400 text-sm md:text-base mobile-text-sm">Total assets</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-2 md:px-3 py-1 bg-green-900/50 text-green-400 rounded-full text-xs mobile-text-xs flex items-center justify-center">
                                        {{ total_assets }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts and dashboard functionality
document.addEventListener('DOMContentLoaded', function() {
    // Timeline Chart
    const timelineChart = echarts.init(document.getElementById('timeline-chart'));
    const timelineOption = {
        animation: false,
        grid: {
            top: 30,
            right: 30,
            bottom: 30,
            left: 50,
            containLabel: true
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            textStyle: {
                color: '#1f2937'
            },
        },
        legend: {
            data: ['Scanned Assets', 'Critical Vulnerabilities', 'Secure Assets'],
            top: 0,
            textStyle: {
                color: 'rgba(255, 255, 255, 0.7)',
                fontSize: 12
            },
            itemWidth: 12,
            itemHeight: 12,
        },

        xAxis: {
            type: 'category',
            data: {{ chart_data.dates | tojson }},
            axisLine: {
                lineStyle: {
                    color: 'rgba(255, 255, 255, 0.1)'
                }
            },
            axisTick: {
                show: false
            },
            axisLabel: {
                color: 'rgba(255, 255, 255, 0.5)',
                fontSize: 12,
                margin: 15
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: 'rgba(255, 255, 255, 0.05)'
                }
            }
        },
        yAxis: {
            type: 'value',
            show: true,
            min: 0,
            max: 100,
            interval: 20,
            axisLine: {
                show: false
            },
            axisTick: {
                show: false
            },
            axisLabel: {
                color: 'rgba(255, 255, 255, 0.5)',
                fontSize: 12,
                margin: 15
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: 'rgba(255, 255, 255, 0.05)'
                }
            }
        },

        series: [
            {
                name: 'Scanned Assets',
                data: [{{ total_assets }}, {{ total_assets + 5 }}, {{ total_assets + 10 }}, {{ total_assets + 8 }}, {{ total_assets + 12 }}, {{ total_assets + 15 }}, {{ total_assets }}],
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '#4ade80',
                    borderWidth: 2,
                    borderColor: '#0f172a'
                },
                lineStyle: {
                    width: 3,
                    color: 'rgba(74, 222, 128, 0.8)'
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {
                            offset: 0,
                            color: 'rgba(74, 222, 128, 0.2)'
                        },
                        {
                            offset: 1,
                            color: 'rgba(74, 222, 128, 0.0)'
                        }
                    ])
                }
            },
            {
                name: 'Critical Vulnerabilities',
                data: [{{ critical_vulns + 2 }}, {{ critical_vulns + 1 }}, {{ critical_vulns }}, {{ critical_vulns - 1 }}, {{ critical_vulns }}, {{ critical_vulns + 1 }}, {{ critical_vulns }}],
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '#f87171',
                    borderWidth: 2,
                    borderColor: '#0f172a'
                },
                lineStyle: {
                    width: 3,
                    color: 'rgba(248, 113, 113, 0.8)'
                }
            },
            {
                name: 'Secure Assets',
                data: [{{ total_assets - critical_vulns }}, {{ total_assets - critical_vulns + 3 }}, {{ total_assets - critical_vulns + 8 }}, {{ total_assets - critical_vulns + 6 }}, {{ total_assets - critical_vulns + 10 }}, {{ total_assets - critical_vulns + 12 }}, {{ total_assets - critical_vulns }}],
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '#60a5fa',
                    borderWidth: 2,
                    borderColor: '#0f172a'
                },
                lineStyle: {
                    width: 3,
                    color: 'rgba(96, 165, 250, 0.8)'
                }
            }
        ]
    };
    timelineChart.setOption(timelineOption);

    // Initialize Network Visualization
    initializeNetworkVisualization();

    // Handle window resize for charts and responsive behavior
    window.addEventListener('resize', function() {
        timelineChart.resize();

        // Update mobile state
        const wasMobile = isMobile;
        checkMobile();

        // Reinitialize sidebar if mobile state changed
        if (wasMobile !== isMobile) {
            if (isMobile) {
                closeMobileSidebar();
                initializeMobileSidebar();
            } else {
                // Reset to desktop mode
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
                initializeSidebar();
            }
        }
    });
});

// Global variables
let sidebarExpanded = localStorage.getItem('sidebarExpanded') === 'true';
let isMobile = window.innerWidth < 768;

// Check if device is mobile
function checkMobile() {
    isMobile = window.innerWidth < 768;
    return isMobile;
}

// Mobile sidebar functionality
function initializeMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
    }

    if (overlay) {
        overlay.addEventListener('click', closeMobileSidebar);
    }

    // Close mobile sidebar when clicking nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            if (isMobile) {
                closeMobileSidebar();
            }
        });
    });
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    if (sidebar.classList.contains('mobile-open')) {
        closeMobileSidebar();
    } else {
        openMobileSidebar();
    }
}

function openMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    sidebar.classList.add('mobile-open');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

// Desktop sidebar functionality
function initializeSidebar() {
    if (checkMobile()) {
        initializeMobileSidebar();
        return;
    }

    const sidebar = document.getElementById('sidebar');
    const logoExpanded = document.getElementById('logo-expanded');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleButton = document.getElementById('sidebar-toggle');

    if (!toggleButton) return;

    const toggleIcon = toggleButton.querySelector('i');

    if (sidebarExpanded) {
        expandSidebar();
    } else {
        collapseSidebar();
    }
}

function expandSidebar() {
    const sidebar = document.getElementById('sidebar');
    const logoExpanded = document.getElementById('logo-expanded');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleButton = document.getElementById('sidebar-toggle');
    const toggleIcon = toggleButton.querySelector('i');
    const toggleText = document.getElementById('toggle-text');

    sidebar.classList.remove('w-16');
    sidebar.classList.add('w-64');

    // Show text elements with delay for smooth animation
    setTimeout(() => {
        logoExpanded.classList.remove('opacity-0');
        logoExpanded.classList.add('opacity-100');
        navTexts.forEach(text => {
            text.classList.remove('opacity-0');
            text.classList.add('opacity-100');
        });
    }, 150);

    // Update toggle button
    toggleIcon.classList.remove('ri-menu-line');
    toggleIcon.classList.add('ri-menu-fold-line');
    toggleText.textContent = 'Collapse';

    sidebarExpanded = true;
    localStorage.setItem('sidebarExpanded', 'true');
}

function collapseSidebar() {
    const sidebar = document.getElementById('sidebar');
    const logoExpanded = document.getElementById('logo-expanded');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleButton = document.getElementById('sidebar-toggle');
    const toggleIcon = toggleButton.querySelector('i');
    const toggleText = document.getElementById('toggle-text');

    // Hide text elements immediately
    logoExpanded.classList.remove('opacity-100');
    logoExpanded.classList.add('opacity-0');
    navTexts.forEach(text => {
        text.classList.remove('opacity-100');
        text.classList.add('opacity-0');
    });

    // Collapse sidebar after text fade
    setTimeout(() => {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-16');
    }, 150);

    // Update toggle button
    toggleIcon.classList.remove('ri-menu-fold-line');
    toggleIcon.classList.add('ri-menu-line');
    toggleText.textContent = 'Expand';

    sidebarExpanded = false;
    localStorage.setItem('sidebarExpanded', 'false');
}

function toggleSidebar() {
    if (sidebarExpanded) {
        collapseSidebar();
    } else {
        expandSidebar();
    }
}

// Navigation functionality
function setActiveNavItem(section) {
    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('bg-slate-700');
        item.classList.add('hover:bg-slate-700');
    });

    // Add active class to selected item
    const activeItem = document.querySelector(`[data-section="${section}"]`);
    if (activeItem) {
        activeItem.classList.add('bg-slate-700');
        activeItem.classList.remove('hover:bg-slate-700');
    }
}

// Initialize sidebar and navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check initial mobile state
    checkMobile();

    // Initialize appropriate sidebar
    initializeSidebar();

    // Add click event to desktop toggle button
    const toggleButton = document.getElementById('sidebar-toggle');
    if (toggleButton) {
        toggleButton.addEventListener('click', toggleSidebar);
    }

    // Navigation items with onclick handlers are handled automatically
    // Only need to handle data-section items for dashboard sections
    document.querySelectorAll('.nav-item[data-section]').forEach(item => {
        item.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            setActiveNavItem(section);

            // Navigate to different pages for data-section items
            if (section === 'assets') {
                window.location.href = '/assets';
            } else if (section === 'settings') {
                window.location.href = '/settings';
            }
        });
    });

    // Prevent zoom on double tap for iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
});

// Network Visualization Functions
let networkCy = null;

function initializeNetworkVisualization() {
    loadNetworkData();

    // Set up refresh button
    const refreshBtn = document.getElementById('refresh-visualization');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            refreshBtn.querySelector('i').classList.add('animate-spin');
            loadNetworkData().finally(() => {
                refreshBtn.querySelector('i').classList.remove('animate-spin');
            });
        });
    }
}

async function loadNetworkData() {
    const loadingEl = document.getElementById('viz-loading');
    const legendEl = document.getElementById('viz-legend');
    const statsEl = document.getElementById('viz-stats');

    try {
        loadingEl.style.display = 'flex';
        legendEl.classList.add('hidden');
        statsEl.classList.add('hidden');

        const response = await fetch('/api/visualization/network-data');
        const data = await response.json();

        if (data.success) {
            createNetworkVisualization(data.nodes, data.edges);
            updateVisualizationStats(data.stats);
            legendEl.classList.remove('hidden');
            statsEl.classList.remove('hidden');
        } else {
            console.error('Failed to load network data:', data.error);
            showVisualizationError(data.error);
        }
    } catch (error) {
        console.error('Error loading network data:', error);
        showVisualizationError('Failed to load network data');
    } finally {
        loadingEl.style.display = 'none';
    }
}

function createNetworkVisualization(nodes, edges) {
    const container = document.getElementById('cy-dashboard');

    // Destroy existing instance
    if (networkCy) {
        networkCy.destroy();
    }

    // Create new Cytoscape instance
    networkCy = cytoscape({
        container: container,
        elements: {
            nodes: nodes,
            edges: edges
        },
        style: [
            {
                selector: 'node',
                style: {
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'color': '#ffffff',
                    'font-size': '10px',
                    'width': '20px',
                    'height': '20px',
                    'text-outline-width': 1,
                    'text-outline-color': '#000000'
                }
            },
            {
                selector: 'node[type="domain"]',
                style: {
                    'background-color': '#3b82f6',
                    'label': 'data(label)',
                    'width': '30px',
                    'height': '30px',
                    'font-size': '12px'
                }
            },
            {
                selector: 'node[type="subdomain"]',
                style: {
                    'background-color': '#10b981',
                    'label': 'data(label)',
                    'width': '25px',
                    'height': '25px'
                }
            },
            {
                selector: 'node[type="port"]',
                style: {
                    'background-color': '#f59e0b',
                    'label': 'data(label)',
                    'width': '15px',
                    'height': '15px',
                    'font-size': '8px'
                }
            },
            {
                selector: 'node[type="technology"]',
                style: {
                    'background-color': '#f59e0b',
                    'label': 'data(label)',
                    'width': '18px',
                    'height': '18px',
                    'font-size': '9px'
                }
            },
            {
                selector: 'node[type="vulnerability"]',
                style: {
                    'background-color': '#dc2626',
                    'label': 'data(label)',
                    'width': '22px',
                    'height': '22px',
                    'font-size': '10px'
                }
            },
            {
                selector: 'node[type="ip"]',
                style: {
                    'background-color': '#6366f1',
                    'label': 'data(label)',
                    'width': '20px',
                    'height': '20px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 1,
                    'line-color': '#64748b',
                    'target-arrow-color': '#64748b',
                    'target-arrow-shape': 'triangle',
                    'target-arrow-size': '6px',
                    'curve-style': 'bezier',
                    'opacity': 0.6
                }
            },
            {
                selector: 'edge[type="has_vulnerability"]',
                style: {
                    'line-color': '#dc2626',
                    'target-arrow-color': '#dc2626',
                    'width': 2
                }
            },
            {
                selector: 'edge[type="parent_domain"]',
                style: {
                    'line-color': '#3b82f6',
                    'target-arrow-color': '#3b82f6',
                    'width': 2
                }
            }
        ],
        layout: {
            name: 'cose',
            animate: true,
            animationDuration: 1000,
            nodeRepulsion: 8000,
            idealEdgeLength: 50,
            edgeElasticity: 100,
            nestingFactor: 1.2,
            gravity: 1,
            numIter: 1000,
            initialTemp: 200,
            coolingFactor: 0.95,
            minTemp: 1.0
        },
        wheelSensitivity: 0.2,
        minZoom: 0.3,
        maxZoom: 3
    });

    // Add event listeners for interactivity
    setupNetworkInteractivity();
}

function setupNetworkInteractivity() {
    const tooltip = document.getElementById('viz-tooltip');
    const tooltipContent = document.getElementById('tooltip-content');

    // Mouse over events
    networkCy.on('mouseover', 'node', function(evt) {
        const node = evt.target;
        const data = node.data();

        let content = `<strong>${data.label}</strong><br>`;
        content += `Type: ${data.type}<br>`;

        if (data.type === 'vulnerability') {
            content += `Severity: ${data.severity}<br>`;
            if (data.cve_id) content += `CVE: ${data.cve_id}<br>`;
        } else if (data.type === 'port') {
            content += `Service: ${data.service || 'Unknown'}<br>`;
        } else if (data.description) {
            content += `Description: ${data.description}<br>`;
        }

        tooltipContent.innerHTML = content;
        tooltip.classList.remove('hidden');
    });

    networkCy.on('mouseout', 'node', function() {
        tooltip.classList.add('hidden');
    });

    // Mouse move for tooltip positioning
    networkCy.on('mousemove', function(e) {
        const container = document.getElementById('network-visualization');
        const rect = container.getBoundingClientRect();
        tooltip.style.left = (e.originalEvent.clientX - rect.left + 10) + 'px';
        tooltip.style.top = (e.originalEvent.clientY - rect.top - 10) + 'px';
    });

    // Click events for node selection
    networkCy.on('tap', 'node', function(evt) {
        const node = evt.target;

        // Highlight connected nodes
        const connectedNodes = node.neighborhood().nodes();
        const connectedEdges = node.neighborhood().edges();

        // Reset all styles
        networkCy.elements().removeClass('highlighted dimmed');

        // Highlight selected node and connected elements
        node.addClass('highlighted');
        connectedNodes.addClass('highlighted');
        connectedEdges.addClass('highlighted');

        // Dim non-connected elements
        networkCy.elements().not(node).not(connectedNodes).not(connectedEdges).addClass('dimmed');
    });

    // Click on background to reset
    networkCy.on('tap', function(evt) {
        if (evt.target === networkCy) {
            networkCy.elements().removeClass('highlighted dimmed');
        }
    });
}

function updateVisualizationStats(stats) {
    document.getElementById('viz-node-count').textContent = `Nodes: ${stats.total_nodes}`;
    document.getElementById('viz-edge-count').textContent = `Edges: ${stats.total_edges}`;
}

function showVisualizationError(message) {
    const container = document.getElementById('cy-dashboard');
    container.innerHTML = `
        <div class="flex items-center justify-center h-full text-slate-400 text-sm">
            <div class="text-center">
                <i class="ri-error-warning-line text-2xl mb-2"></i><br>
                ${message}
            </div>
        </div>
    `;
}

</script>

<!-- Add custom styles for network visualization -->
<style>
#cy-dashboard .highlighted {
    opacity: 1 !important;
}

#cy-dashboard .dimmed {
    opacity: 0.3 !important;
}

.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
