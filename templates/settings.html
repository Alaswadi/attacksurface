{% extends "base.html" %}

{% block title %}Settings - Attack Surface Monitoring{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden bg-slate-900">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-slate-900 border-r border-slate-800 flex flex-col text-white transition-all duration-300 ease-in-out w-16">
        <!-- Logo Section -->
        <div class="flex items-center justify-center py-6 mb-6">
            <!-- Expanded text only -->
            <div id="logo-expanded" class="opacity-0 transition-opacity duration-300 flex items-center justify-center w-full px-4">
                <span class="text-white font-bold text-lg whitespace-nowrap">AttackSurfacePro</span>
            </div>
        </div>

        <!-- Navigation Items -->
        <nav class="flex-1 px-2">
            <!-- Dashboard -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/dashboard'" title="Dashboard">
                <div class="flex items-center">
                    <i class="ri-dashboard-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Dashboard</span>
                </div>
            </div>

            <!-- Assets -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/assets'" title="Assets">
                <div class="flex items-center">
                    <i class="ri-computer-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Assets</span>
                </div>
            </div>

            <!-- Vulnerabilities -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/vulnerabilities'" title="Vulnerabilities">
                <div class="flex items-center">
                    <i class="ri-bug-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Vulnerabilities</span>
                </div>
            </div>

            <!-- Technologies -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/technologies'" title="Technology Discovery">
                <div class="flex items-center">
                    <i class="ri-stack-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Technologies</span>
                </div>
            </div>

            <!-- Graph -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/graph'" title="Network Graph">
                <div class="flex items-center">
                    <i class="ri-node-tree ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Graph</span>
                </div>
            </div>

            <!-- Reports -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors relative" onclick="window.location.href='/reports'" title="Reports">
                <div class="flex items-center">
                    <i class="ri-file-chart-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Reports</span>
                </div>
            </div>

            <!-- Settings -->
            <div class="nav-item mb-2 p-3 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors bg-slate-700 relative" title="Settings">
                <div class="flex items-center">
                    <i class="ri-settings-3-line ri-lg min-w-[24px]"></i>
                    <span class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Settings</span>
                </div>
            </div>
        </nav>

        <!-- Toggle Button -->
        <div class="p-2">
            <button id="sidebar-toggle" class="w-full p-3 rounded-lg hover:bg-slate-700 transition-colors flex items-center justify-center" title="Toggle Sidebar">
                <i class="ri-menu-line ri-lg min-w-[24px]"></i>
                <span id="toggle-text" class="nav-text ml-3 opacity-0 transition-opacity duration-300 whitespace-nowrap">Expand</span>
            </button>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-4 md:px-6">
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-lg hover:bg-slate-700 transition-colors">
                <i class="ri-menu-line text-xl text-white"></i>
            </button>

            <div class="flex items-center justify-between w-full lg:w-auto">
                <h1 class="text-xl md:text-2xl font-bold text-white">Settings</h1>
            </div>

            <!-- User Menu -->
            <div class="relative">
                <button class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-700 hover:bg-slate-600 transition-colors" onclick="toggleUserMenu()">
                    <i class="ri-user-line text-white"></i>
                </button>
                <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-1 z-50">
                    <a href="#" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Profile</a>
                    <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Logout</a>
                </div>
            </div>
        </header>

        <!-- Settings Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
            <!-- Page Title -->
            <div class="mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold mb-2 text-white">System Configuration</h2>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-slate-400">
                            <div class="flex items-center gap-2">
                                <span>Manage application settings and preferences</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tabs -->
                <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-1 mb-6">
                    <div class="flex flex-wrap gap-1">
                        <button class="settings-tab active flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md bg-primary text-slate-900 transition-all duration-200" data-tab="general">
                            <i class="ri-settings-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">General</span>
                            <span class="sm:hidden">Gen</span>
                        </button>
                        <button class="settings-tab flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200" data-tab="scanning">
                            <i class="ri-radar-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">Scanning</span>
                            <span class="sm:hidden">Scan</span>
                        </button>
                        <button class="settings-tab flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200" data-tab="notifications">
                            <i class="ri-notification-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">Notifications</span>
                            <span class="sm:hidden">Notif</span>
                        </button>
                        <button class="settings-tab flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200" data-tab="users">
                            <i class="ri-team-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">Users</span>
                            <span class="sm:hidden">Users</span>
                        </button>
                        <button class="settings-tab flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200" data-tab="data">
                            <i class="ri-database-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">Data</span>
                            <span class="sm:hidden">Data</span>
                        </button>
                        <button class="settings-tab flex-1 min-w-0 px-3 md:px-4 py-2 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all duration-200" data-tab="integrations">
                            <i class="ri-plug-line mr-1 md:mr-2"></i>
                            <span class="hidden sm:inline">Integrations</span>
                            <span class="sm:hidden">Int</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="settings-content">
                <!-- General Settings Tab -->
                <div id="general-tab" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Organization Details -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-building-line mr-2 text-primary"></i>Organization Details
                            </h3>
                            <form id="organization-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Organization Name *</label>
                                    <input type="text" id="org-name" value="{{ organization.name }}" required
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                    <div id="org-name-error" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Primary Domain</label>
                                    <input type="text" id="primary-domain" value="{{ organization.primary_domain or '' }}" placeholder="example.com"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                    <div id="primary-domain-error" class="text-red-400 text-sm mt-1 hidden"></div>
                                    <p class="text-xs text-slate-500 mt-1">Your organization's main domain for attack surface monitoring</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Description</label>
                                    <textarea id="org-description" rows="3" placeholder="Organization description..."
                                              class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">{{ organization.description or '' }}</textarea>
                                    <div id="org-description-error" class="text-red-400 text-sm mt-1 hidden"></div>
                                    <p class="text-xs text-slate-500 mt-1">Brief description of your organization (max 500 characters)</p>
                                </div>
                                <button type="submit" id="save-org-btn" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="btn-text">Save Organization Details</span>
                                    <span class="btn-loading hidden">
                                        <i class="ri-loader-4-line animate-spin mr-2"></i>Saving...
                                    </span>
                                </button>
                            </form>
                        </div>

                        <!-- Interface Preferences -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-palette-line mr-2 text-primary"></i>Interface Preferences
                            </h3>
                            <form id="interface-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Default View</label>
                                    <select id="default-view" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="dashboard">Dashboard</option>
                                        <option value="assets">Assets</option>
                                        <option value="vulnerabilities">Vulnerabilities</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Theme</label>
                                    <select id="theme" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="light">Light</option>
                                        <option value="dark" selected>Dark</option>
                                        <option value="auto">Auto</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Items per Page</label>
                                    <select id="items-per-page" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="sidebar-expanded" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="sidebar-expanded" class="ml-2 block text-sm text-slate-300">Keep sidebar expanded by default</label>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Interface Preferences
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Scanning Configuration Tab -->
                <div id="scanning-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Auto-scan Settings -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-timer-line mr-2 text-primary"></i>Auto-scan Configuration
                            </h3>
                            <form id="autoscan-form" class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto-scan-enabled" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="auto-scan-enabled" class="ml-2 block text-sm text-slate-300">Enable auto-scan for new assets</label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Scan Frequency</label>
                                    <select id="scan-frequency" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="daily">Daily</option>
                                        <option value="weekly" selected>Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Scan Time</label>
                                    <input type="time" id="scan-time" value="02:00"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="deep-scan" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="deep-scan" class="ml-2 block text-sm text-slate-300">Enable deep scanning (slower but more thorough)</label>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Auto-scan Settings
                                </button>
                            </form>
                        </div>

                        <!-- Technology Detection -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-stack-line mr-2 text-primary"></i>Technology Detection
                            </h3>
                            <form id="tech-detection-form" class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="tech-detection-enabled" checked class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="tech-detection-enabled" class="ml-2 block text-sm text-slate-300">Enable technology detection</label>
                                </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Update Frequency</label>
                                    <select id="tech-update-frequency" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="daily">Daily</option>
                                        <option value="weekly" selected>Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Technology Settings
                                </button>
                            </form>
                        </div>

                        <!-- Scan Performance -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-speed-line mr-2 text-primary"></i>Scan Performance
                            </h3>
                            <form id="performance-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Concurrent Scans</label>
                                    <input type="range" id="concurrent-scans" min="1" max="10" value="3"
                                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>1</span>
                                        <span id="concurrent-value" class="text-primary font-medium">3</span>
                                        <span>10</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Timeout (seconds)</label>
                                    <input type="number" id="scan-timeout" value="300" min="60" max="3600"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Rate Limit (requests/sec)</label>
                                    <input type="number" id="rate-limit" value="100" min="10" max="1000"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Performance Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div id="notifications-tab" class="tab-content hidden">
                    <!-- Single form for all notification settings -->
                    <form id="notification-settings-form" class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Email Notifications -->
                            <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">
                                    <i class="ri-mail-line mr-2 text-primary"></i>Email Notifications
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="email-enabled" checked class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                        <label for="email-enabled" class="ml-2 block text-sm text-slate-300">Enable email notifications</label>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">Notification Email</label>
                                        <input type="email" id="notification-email" value="{{ current_user.email }}"
                                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">Additional Recipients</label>
                                        <textarea id="additional-recipients" rows="3" placeholder="email1@example.com, email2@example.com"
                                                  class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">Digest Frequency</label>
                                        <select id="digest-frequency" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                            <option value="immediate">Immediate</option>
                                            <option value="hourly">Hourly</option>
                                            <option value="daily" selected>Daily</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Alert Thresholds -->
                            <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">
                                    <i class="ri-alarm-warning-line mr-2 text-primary"></i>Alert Severity Thresholds
                                </h3>
                                <div class="space-y-4">
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="critical-alerts" checked class="h-4 w-4 text-red-400 focus:ring-red-400 border-slate-600 bg-slate-700 rounded">
                                                <label for="critical-alerts" class="ml-2 block text-sm text-slate-300">Critical</label>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30 rounded-full">Immediate</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="high-alerts" checked class="h-4 w-4 text-orange-400 focus:ring-orange-400 border-slate-600 bg-slate-700 rounded">
                                                <label for="high-alerts" class="ml-2 block text-sm text-slate-300">High</label>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-orange-500/20 text-orange-400 border border-orange-500/30 rounded-full">Immediate</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="medium-alerts" checked class="h-4 w-4 text-yellow-400 focus:ring-yellow-400 border-slate-600 bg-slate-700 rounded">
                                                <label for="medium-alerts" class="ml-2 block text-sm text-slate-300">Medium</label>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-full">Daily</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="low-alerts" class="h-4 w-4 text-blue-400 focus:ring-blue-400 border-slate-600 bg-slate-700 rounded">
                                                <label for="low-alerts" class="ml-2 block text-sm text-slate-300">Low</label>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30 rounded-full">Weekly</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="info-alerts" class="h-4 w-4 text-slate-400 focus:ring-slate-400 border-slate-600 bg-slate-700 rounded">
                                                <label for="info-alerts" class="ml-2 block text-sm text-slate-300">Info</label>
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium bg-slate-500/20 text-slate-400 border border-slate-500/30 rounded-full">Weekly</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Single Save Button -->
                        <div class="flex justify-center">
                            <button type="submit" id="save-notification-settings-btn" class="bg-primary hover:bg-primary/90 text-slate-900 py-3 px-8 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                <i class="ri-save-line mr-2"></i>Save Notification Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Users Tab -->
                <div id="users-tab" class="tab-content hidden">
                    {% if can_manage_settings() %}
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- User Management -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-user-settings-line mr-2 text-primary"></i>Team Members
                            </h3>
                            <div class="space-y-4">
                                <!-- Current user (owner) -->
                                <div class="flex items-center justify-between p-3 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                            <i class="ri-user-line text-slate-900 text-sm"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm font-medium text-white">{{ current_user.username }}</p>
                                            <p class="text-xs text-slate-400">{{ current_user.email }}</p>
                                        </div>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30 rounded-full">Owner</span>
                                </div>

                                <!-- Team members list -->
                                <div id="team-members-list" class="space-y-2">
                                    <!-- Dynamic content will be loaded here -->
                                </div>

                                <!-- Pending invitations -->
                                <div id="pending-invitations" class="space-y-2">
                                    <!-- Dynamic content will be loaded here -->
                                </div>

                                <button id="invite-user-btn" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    <i class="ri-user-add-line mr-2"></i>Invite Team Member
                                </button>
                            </div>
                        </div>

                        <!-- User Invitation Form -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-mail-send-line mr-2 text-primary"></i>Invite New User
                            </h3>
                            <form id="user-invitation-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Email Address *</label>
                                    <input type="email" id="invite-email" required
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400"
                                           placeholder="user@example.com">
                                    <div id="invite-email-error" class="text-red-400 text-sm mt-1 hidden"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Role</label>
                                    <select id="invite-role" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="admin">Admin</option>
                                        <option value="viewer" selected>Viewer</option>
                                    </select>
                                    <p class="text-xs text-slate-400 mt-1">
                                        <strong>Admin:</strong> Full access to all features<br>
                                        <strong>Viewer:</strong> Read-only access to assets, vulnerabilities, technologies, and reports
                                    </p>
                                </div>
                                <button type="submit" id="send-invitation-btn" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="btn-text">Send Invitation</span>
                                    <span class="btn-loading hidden">
                                        <i class="ri-loader-4-line animate-spin mr-2"></i>Sending...
                                    </span>
                                </button>
                            </form>
                        </div>



                        <!-- Activity Logs -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-history-line mr-2 text-primary"></i>Recent Activity
                            </h3>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                                <div class="flex items-center p-3 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="w-8 h-8 bg-green-500/20 border border-green-500/30 rounded-full flex items-center justify-center">
                                        <i class="ri-login-circle-line text-green-400 text-sm"></i>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="text-sm text-white">User logged in</p>
                                        <p class="text-xs text-slate-400">{{ current_user.username }} • Just now</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="w-8 h-8 bg-blue-500/20 border border-blue-500/30 rounded-full flex items-center justify-center">
                                        <i class="ri-settings-line text-blue-400 text-sm"></i>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="text-sm text-white">Settings accessed</p>
                                        <p class="text-xs text-slate-400">{{ current_user.username }} • 2 minutes ago</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="ri-lock-line text-4xl text-slate-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-white mb-2">Access Restricted</h3>
                        <p class="text-slate-400">You need admin permissions to manage users.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Data Management Tab -->
                <div id="data-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Data Retention -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-time-line mr-2 text-primary"></i>Data Retention Policies
                            </h3>
                            <form id="retention-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Scan Results Retention</label>
                                    <select id="scan-retention" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="30">30 days</option>
                                        <option value="90" selected>90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365">1 year</option>
                                        <option value="0">Never delete</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Vulnerability Data Retention</label>
                                    <select id="vuln-retention" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="90">90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365" selected>1 year</option>
                                        <option value="730">2 years</option>
                                        <option value="0">Never delete</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Alert History Retention</label>
                                    <select id="alert-retention" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="30">30 days</option>
                                        <option value="90" selected>90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365">1 year</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Retention Policies
                                </button>
                            </form>
                        </div>

                        <!-- Export/Import -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-download-cloud-line mr-2 text-primary"></i>Export/Import Data
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Export Data</label>
                                    <div class="space-y-2">
                                        <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                            <i class="ri-file-excel-line mr-2"></i>Export to CSV
                                        </button>
                                        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                            <i class="ri-file-code-line mr-2"></i>Export to JSON
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Import Data</label>
                                    <input type="file" id="import-file" accept=".csv,.json"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-slate-900 hover:file:bg-primary/90">
                                    <button class="w-full mt-2 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                        <i class="ri-upload-cloud-line mr-2"></i>Import Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Database Backup -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-database-2-line mr-2 text-primary"></i>Database Backup
                            </h3>
                            <form id="backup-form" class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto-backup" checked class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="auto-backup" class="ml-2 block text-sm text-slate-300">Enable automatic backups</label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Backup Frequency</label>
                                    <select id="backup-frequency" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="daily" selected>Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Backup Retention</label>
                                    <select id="backup-retention" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="7">7 days</option>
                                        <option value="30" selected>30 days</option>
                                        <option value="90">90 days</option>
                                    </select>
                                </div>
                                <button type="button" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    <i class="ri-download-line mr-2"></i>Create Backup Now
                                </button>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Backup Settings
                                </button>
                            </form>
                        </div>

                        <!-- Asset Cleanup -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-delete-bin-line mr-2 text-primary"></i>Asset Cleanup Rules
                            </h3>
                            <form id="cleanup-form" class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto-cleanup" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="auto-cleanup" class="ml-2 block text-sm text-slate-300">Enable automatic cleanup</label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Remove inactive assets after</label>
                                    <select id="inactive-threshold" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                        <option value="30">30 days</option>
                                        <option value="90" selected>90 days</option>
                                        <option value="180">6 months</option>
                                        <option value="365">1 year</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="cleanup-resolved" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="cleanup-resolved" class="ml-2 block text-sm text-slate-300">Remove resolved vulnerabilities after 90 days</label>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Cleanup Rules
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Integrations Tab -->
                <div id="integrations-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Email Configuration -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-mail-settings-line mr-2 text-primary"></i>Email Configuration
                                <span id="email-status-badge" class="ml-2 px-2 py-1 text-xs font-medium rounded-full">
                                    <!-- Status will be updated dynamically -->
                                </span>
                            </h3>
                            <form id="email-config-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">SMTP Host *</label>
                                        <input type="text" id="smtp-host" required placeholder="smtp.gmail.com"
                                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">SMTP Port *</label>
                                        <input type="number" id="smtp-port" required value="587" min="1" max="65535"
                                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Username *</label>
                                    <input type="text" id="smtp-username" required placeholder="your-email@gmail.com"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Password *</label>
                                    <input type="password" id="smtp-password" required placeholder="App password or SMTP password"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="smtp-use-tls" checked class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                        <label for="smtp-use-tls" class="ml-2 block text-sm text-slate-300">Use TLS</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="smtp-use-ssl" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                        <label for="smtp-use-ssl" class="ml-2 block text-sm text-slate-300">Use SSL</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">From Email *</label>
                                    <input type="email" id="from-email" required placeholder="noreply@yourcompany.com"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">From Name *</label>
                                    <input type="text" id="from-name" required placeholder="AttackSurfacePro"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Reply To</label>
                                    <input type="email" id="reply-to" placeholder="support@yourcompany.com"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <button type="submit" id="save-email-config-btn" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="btn-text">Save Email Configuration</span>
                                    <span class="btn-loading hidden">
                                        <i class="ri-loader-4-line animate-spin mr-2"></i>Saving...
                                    </span>
                                </button>
                            </form>
                        </div>

                        <!-- Email Testing -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-mail-check-line mr-2 text-primary"></i>Test Email Configuration
                            </h3>
                            <div class="space-y-4">
                                <div id="email-test-status" class="hidden p-3 rounded-lg">
                                    <!-- Test status will be shown here -->
                                </div>
                                <form id="test-email-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-400 mb-2">Test Email Address</label>
                                        <input type="email" id="test-email" required placeholder="test@example.com"
                                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                    </div>
                                    <button type="submit" id="send-test-email-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span class="btn-text">
                                            <i class="ri-mail-send-line mr-2"></i>Send Test Email
                                        </span>
                                        <span class="btn-loading hidden">
                                            <i class="ri-loader-4-line animate-spin mr-2"></i>Sending...
                                        </span>
                                    </button>
                                </form>

                                <!-- Email Templates Section -->
                                <div class="mt-6 pt-6 border-t border-slate-600">
                                    <h4 class="text-md font-semibold text-white mb-3">
                                        <i class="ri-file-text-line mr-2 text-primary"></i>Email Templates
                                    </h4>
                                    <p class="text-slate-400 text-sm mb-4">
                                        Test the professional email templates used for security alerts and scan completion notifications.
                                    </p>
                                    <div class="space-y-4">
                                        <div id="template-test-status" class="hidden p-3 rounded-lg">
                                            <!-- Template test status will be shown here -->
                                        </div>
                                        <form id="template-test-form" class="space-y-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-slate-400 mb-2">Template Type</label>
                                                    <select id="template-type" required
                                                            class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white">
                                                        <option value="">Select template type</option>
                                                        <option value="security_alert">Security Alert</option>
                                                        <option value="scan_completion">Scan Completion</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-slate-400 mb-2">Test Email Address</label>
                                                    <input type="email" id="template-test-email" required placeholder="test@example.com"
                                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                                </div>
                                            </div>
                                            <button type="submit" id="send-template-test-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                                <span class="btn-text">
                                                    <i class="ri-mail-star-line mr-2"></i>Send Template Test
                                                </span>
                                                <span class="btn-loading hidden">
                                                    <i class="ri-loader-4-line animate-spin mr-2"></i>Sending...
                                                </span>
                                            </button>
                                        </form>

                                        <!-- Template Descriptions -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                            <div class="bg-slate-700/50 rounded-lg p-3">
                                                <h5 class="text-white font-medium mb-2 text-sm">
                                                    <i class="ri-shield-cross-line mr-2 text-red-400"></i>Security Alert
                                                </h5>
                                                <p class="text-slate-400 text-xs">
                                                    Sent when critical or high severity vulnerabilities are detected during scans.
                                                    Includes vulnerability details, recommendations, and organization summary.
                                                </p>
                                            </div>
                                            <div class="bg-slate-700/50 rounded-lg p-3">
                                                <h5 class="text-white font-medium mb-2 text-sm">
                                                    <i class="ri-check-double-line mr-2 text-green-400"></i>Scan Completion
                                                </h5>
                                                <p class="text-slate-400 text-xs">
                                                    Sent when security scans complete successfully.
                                                    Includes discovered assets, vulnerability counts, and scan statistics.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Settings -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-webhook-line mr-2 text-primary"></i>Webhook Configuration
                            </h3>
                            <form id="webhook-form" class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="webhooks-enabled" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                    <label for="webhooks-enabled" class="ml-2 block text-sm text-slate-300">Enable webhooks</label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Webhook URL</label>
                                    <input type="url" id="webhook-url" placeholder="https://your-app.com/webhook"
                                           class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-white placeholder-slate-400">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-400 mb-2">Events</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="webhook-new-vuln" checked class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                            <label for="webhook-new-vuln" class="ml-2 block text-sm text-slate-300">New vulnerability discovered</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="webhook-scan-complete" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                            <label for="webhook-scan-complete" class="ml-2 block text-sm text-slate-300">Scan completed</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="webhook-new-asset" class="h-4 w-4 text-primary focus:ring-primary border-slate-600 bg-slate-700 rounded">
                                            <label for="webhook-new-asset" class="ml-2 block text-sm text-slate-300">New asset discovered</label>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                    Save Webhook Settings
                                </button>
                            </form>
                        </div>

                        <!-- Third-party Integrations -->
                        <div class="card bg-slate-800/50 border border-slate-700 rounded-lg p-4 md:p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="ri-links-line mr-2 text-primary"></i>Third-party Integrations
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <i class="ri-slack-line text-2xl text-purple-400 mr-3"></i>
                                            <span class="font-medium text-white">Slack</span>
                                        </div>
                                        <span class="px-2 py-1 text-xs bg-slate-500/20 text-slate-400 border border-slate-500/30 rounded-full">Not Connected</span>
                                    </div>
                                    <button class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                        Connect
                                    </button>
                                </div>
                                <div class="p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <i class="ri-microsoft-line text-2xl text-blue-400 mr-3"></i>
                                            <span class="font-medium text-white">Teams</span>
                                        </div>
                                        <span class="px-2 py-1 text-xs bg-slate-500/20 text-slate-400 border border-slate-500/30 rounded-full">Not Connected</span>
                                    </div>
                                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                        Connect
                                    </button>
                                </div>
                                <div class="p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <i class="ri-mail-line text-2xl text-red-400 mr-3"></i>
                                            <span class="font-medium text-white">Email</span>
                                        </div>
                                        <span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 border border-green-500/30 rounded-full">Connected</span>
                                    </div>
                                    <button class="w-full bg-slate-600 hover:bg-slate-500 text-white py-2 px-4 rounded-lg transition-all duration-200 font-medium shadow-lg hover:shadow-xl hover:scale-105">
                                        Configure
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Custom slider styling for dark theme */
.slider::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #10b981;
    cursor: pointer;
    border: 2px solid #0f172a;
}

.slider::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #10b981;
    cursor: pointer;
    border: 2px solid #0f172a;
}

.slider::-webkit-slider-track {
    height: 8px;
    border-radius: 4px;
    background: #475569;
}

.slider::-moz-range-track {
    height: 8px;
    border-radius: 4px;
    background: #475569;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let isMobile = false;

// Check if mobile
function checkMobile() {
    return window.innerWidth < 1024;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeSidebar();
    initializeMobileSidebar();
    initializeTabSwitching();
    initializeFormHandlers();
    initializeSliders();

    // Navigation items with onclick handlers are handled automatically
    // No additional navigation handlers needed since all items now use onclick
});

// Sidebar functionality
function initializeSidebar() {
    const isExpanded = localStorage.getItem('sidebarExpanded') === 'true';
    if (isExpanded && !checkMobile()) {
        expandSidebar();
    }

    const sidebarToggle = document.getElementById('sidebar-toggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            if (checkMobile()) {
                toggleMobileSidebar();
            } else {
                toggleSidebar();
            }
        });
    }
}

function expandSidebar() {
    if (checkMobile()) return;

    const sidebar = document.getElementById('sidebar');
    const logoExpanded = document.getElementById('logo-expanded');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleText = document.getElementById('toggle-text');

    sidebar.classList.remove('w-16');
    sidebar.classList.add('w-64');

    setTimeout(() => {
        logoExpanded.classList.remove('opacity-0');
        logoExpanded.classList.add('opacity-100');
        navTexts.forEach(text => text.classList.remove('opacity-0'));
        toggleText.classList.remove('opacity-0');
        toggleText.textContent = 'Collapse';
    }, 150);

    localStorage.setItem('sidebarExpanded', 'true');
}

function collapseSidebar() {
    if (checkMobile()) return;

    const sidebar = document.getElementById('sidebar');
    const logoExpanded = document.getElementById('logo-expanded');
    const navTexts = document.querySelectorAll('.nav-text');
    const toggleText = document.getElementById('toggle-text');

    logoExpanded.classList.remove('opacity-100');
    logoExpanded.classList.add('opacity-0');
    navTexts.forEach(text => text.classList.add('opacity-0'));
    toggleText.classList.add('opacity-0');

    setTimeout(() => {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-16');
        toggleText.textContent = 'Expand';
    }, 150);

    localStorage.setItem('sidebarExpanded', 'false');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('w-64')) {
        collapseSidebar();
    } else {
        expandSidebar();
    }
}

// Mobile sidebar functionality
function initializeMobileSidebar() {
    const overlay = document.getElementById('sidebar-overlay');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
    }

    if (overlay) {
        overlay.addEventListener('click', closeMobileSidebar);
    }

    // Close mobile sidebar when clicking nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            if (checkMobile()) {
                closeMobileSidebar();
            }
        });
    });
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');

    if (sidebar.classList.contains('translate-x-0')) {
        closeMobileSidebar();
    } else {
        openMobileSidebar();
    }
}

function openMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    sidebar.classList.remove('-translate-x-full');
    sidebar.classList.add('translate-x-0');
    sidebar.classList.add('fixed', 'z-50', 'w-64');

    if (overlay) {
        overlay.classList.remove('hidden');
    }

    // Show nav text immediately on mobile
    const navTexts = document.querySelectorAll('.nav-text');
    const logoExpanded = document.getElementById('logo-expanded');
    navTexts.forEach(text => text.classList.remove('opacity-0'));
    if (logoExpanded) {
        logoExpanded.classList.remove('opacity-0');
        logoExpanded.classList.add('opacity-100');
    }
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    sidebar.classList.remove('translate-x-0');
    sidebar.classList.add('-translate-x-full');

    if (overlay) {
        overlay.classList.add('hidden');
    }

    setTimeout(() => {
        sidebar.classList.remove('fixed', 'z-50', 'w-64');
        sidebar.classList.add('w-16');

        // Hide nav text on mobile when closed
        const navTexts = document.querySelectorAll('.nav-text');
        const logoExpanded = document.getElementById('logo-expanded');
        navTexts.forEach(text => text.classList.add('opacity-0'));
        if (logoExpanded) {
            logoExpanded.classList.remove('opacity-100');
            logoExpanded.classList.add('opacity-0');
        }
    }, 300);
}

function toggleUserMenu() {
    const menu = document.getElementById('userMenu');
    menu.classList.toggle('hidden');
}

// Close user menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('userMenu');
    const button = event.target.closest('button');
    if (!button || !button.onclick) {
        menu.classList.add('hidden');
    }
});

// Handle window resize
window.addEventListener('resize', function() {
    const wasMobile = isMobile;
    isMobile = checkMobile();

    if (wasMobile !== isMobile) {
        // Reset sidebar state when switching between mobile/desktop
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        if (isMobile) {
            closeMobileSidebar();
        } else {
            // Reset to desktop state
            sidebar.classList.remove('fixed', 'z-50', 'translate-x-0', '-translate-x-full');
            if (overlay) overlay.classList.add('hidden');

            // Apply saved desktop state
            const isExpanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (isExpanded) {
                sidebar.classList.add('w-64');
                sidebar.classList.remove('w-16');
            } else {
                sidebar.classList.add('w-16');
                sidebar.classList.remove('w-64');
            }
        }
    }
});

// Tab switching functionality
function initializeTabSwitching() {
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
}

function switchTab(tabName) {
    // Update tab buttons - remove active state from all tabs
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active', 'bg-primary', 'text-slate-900');
        tab.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-slate-700/50');
    });

    // Add active state to clicked tab
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'bg-primary', 'text-slate-900');
        activeTab.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-slate-700/50');
    }

    // Show/hide tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });

    const activeContent = document.getElementById(`${tabName}-tab`);
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }
}

// Form handlers
function initializeFormHandlers() {
    // Organization form
    document.getElementById('organization-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveOrganizationSettings();
    });

    // Interface form
    document.getElementById('interface-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveInterfaceSettings();
    });

    // Auto-scan form
    document.getElementById('autoscan-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveAutoscanSettings();
    });

    // Add more form handlers as needed
}

// Slider functionality
function initializeSliders() {
    const concurrentSlider = document.getElementById('concurrent-scans');
    const concurrentValue = document.getElementById('concurrent-value');

    if (concurrentSlider && concurrentValue) {
        concurrentSlider.addEventListener('input', function() {
            concurrentValue.textContent = this.value;
        });
    }
}

// Settings save functions
function saveOrganizationSettings() {
    const orgName = document.getElementById('org-name').value.trim();
    const primaryDomain = document.getElementById('primary-domain').value.trim();
    const orgDescription = document.getElementById('org-description').value.trim();

    // Clear previous errors
    clearFormErrors(['org-name-error', 'primary-domain-error', 'org-description-error']);

    // Validate form
    let hasErrors = false;

    if (!orgName) {
        showFieldError('org-name-error', 'Organization name is required');
        hasErrors = true;
    }

    if (primaryDomain && !isValidDomain(primaryDomain)) {
        showFieldError('primary-domain-error', 'Please enter a valid domain name');
        hasErrors = true;
    }

    if (orgDescription && orgDescription.length > 500) {
        showFieldError('org-description-error', 'Description must be 500 characters or less');
        hasErrors = true;
    }

    if (hasErrors) return;

    // Show loading state
    setButtonLoading('save-org-btn', true);

    // Send API request
    fetch('/api/settings/organization', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: orgName,
            primary_domain: primaryDomain || null,
            description: orgDescription || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Organization settings saved successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to save organization settings', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to save organization settings', 'error');
    })
    .finally(() => {
        setButtonLoading('save-org-btn', false);
    });
}

function saveInterfaceSettings() {
    const defaultView = document.getElementById('default-view').value;
    const theme = document.getElementById('theme').value;
    const itemsPerPage = document.getElementById('items-per-page').value;
    const sidebarExpanded = document.getElementById('sidebar-expanded').checked;

    // Save to localStorage
    localStorage.setItem('defaultView', defaultView);
    localStorage.setItem('theme', theme);
    localStorage.setItem('itemsPerPage', itemsPerPage);
    localStorage.setItem('sidebarExpanded', sidebarExpanded);

    showNotification('Interface preferences saved successfully!', 'success');
}

function saveAutoscanSettings() {
    const autoScanEnabled = document.getElementById('auto-scan-enabled').checked;
    const scanFrequency = document.getElementById('scan-frequency').value;
    const scanTime = document.getElementById('scan-time').value;
    const deepScan = document.getElementById('deep-scan').checked;

    showNotification('Auto-scan settings saved successfully!', 'success');
}

// Utility functions
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' :
        type === 'error' ? 'bg-red-100 text-red-700 border border-red-300' :
        'bg-blue-100 text-blue-700 border border-blue-300'
    }`;

    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg font-bold">&times;</button>
        </div>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function toggleApiKey() {
    const apiKeyInput = document.getElementById('api-key');
    const eyeIcon = document.querySelector('#api-key').nextElementSibling.querySelector('i');

    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        eyeIcon.classList.remove('ri-eye-line');
        eyeIcon.classList.add('ri-eye-off-line');
    } else {
        apiKeyInput.type = 'password';
        eyeIcon.classList.remove('ri-eye-off-line');
        eyeIcon.classList.add('ri-eye-line');
    }
}

// Enhanced utility functions
function clearFormErrors(errorIds) {
    errorIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('hidden');
            element.textContent = '';
        }
    });
}

function showFieldError(errorId, message) {
    const element = document.getElementById(errorId);
    if (element) {
        element.textContent = message;
        element.classList.remove('hidden');
    }
}

function setButtonLoading(buttonId, loading) {
    const button = document.getElementById(buttonId);
    if (!button) return;

    const textSpan = button.querySelector('.btn-text');
    const loadingSpan = button.querySelector('.btn-loading');

    if (loading) {
        button.disabled = true;
        if (textSpan) textSpan.classList.add('hidden');
        if (loadingSpan) loadingSpan.classList.remove('hidden');
    } else {
        button.disabled = false;
        if (textSpan) textSpan.classList.remove('hidden');
        if (loadingSpan) loadingSpan.classList.add('hidden');
    }
}

function isValidDomain(domain) {
    const domainPattern = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/;
    return domainPattern.test(domain);
}

function isValidEmail(email) {
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailPattern.test(email);
}

// User Management Functions
function getCurrentUserEmail() {
    // Get current user email from the template context
    return '{{ current_user.email }}';
}

function loadTeamMembers() {
    fetch('/api/settings/users')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error loading team members:', data.error);
            return;
        }

        displayTeamMembers(data.users);
        displayPendingInvitations(data.pending_invitations);
    })
    .catch(error => {
        console.error('Error loading team members:', error);
    });
}

function displayTeamMembers(users) {
    const container = document.getElementById('team-members-list');
    if (!container) return;

    if (users.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-sm">No team members yet.</p>';
        return;
    }

    container.innerHTML = users.map(user => {
        // Check if this is the current user or if they have special restrictions
        const currentUserEmail = getCurrentUserEmail();
        const isCurrentUser = user.email === currentUserEmail;
        // Check if this user is the organization owner (has all permissions)
        const isOwner = user.permissions && user.permissions.can_manage_settings && user.role === 'admin';
        const canEdit = !isCurrentUser; // Users can't edit themselves
        const canDelete = !isCurrentUser && !isOwner; // Can't delete self or organization owner

        return `
        <div class="flex items-center justify-between p-3 bg-slate-700/50 border border-slate-600 rounded-lg">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center">
                    <i class="ri-user-line text-slate-300 text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-white">
                        ${user.username}
                        ${isCurrentUser ? '<span class="ml-2 px-2 py-1 text-xs bg-green-500/20 text-green-400 border border-green-500/30 rounded-full">You</span>' : ''}
                        ${isOwner && !isCurrentUser ? '<span class="ml-2 px-2 py-1 text-xs bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-full">Owner</span>' : ''}
                    </p>
                    <p class="text-xs text-slate-400">${user.email}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="px-2 py-1 text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30 rounded-full">
                    ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                </span>
                ${canEdit ? `
                    <button onclick="editUser(${user.id})" class="text-primary hover:text-primary/80 text-sm" title="Edit user">
                        <i class="ri-edit-line"></i>
                    </button>
                ` : `
                    <button disabled class="text-slate-500 text-sm cursor-not-allowed" title="Cannot edit yourself">
                        <i class="ri-edit-line"></i>
                    </button>
                `}
                ${canDelete ? `
                    <button onclick="removeUser(${user.id})" class="text-red-400 hover:text-red-300 text-sm" title="Remove user">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                ` : `
                    <button disabled class="text-slate-500 text-sm cursor-not-allowed" title="${isCurrentUser ? 'Cannot remove yourself' : 'Cannot remove organization owner'}">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                `}
            </div>
        </div>
        `;
    }).join('');
}

function displayPendingInvitations(invitations) {
    const container = document.getElementById('pending-invitations');
    if (!container) return;

    if (invitations.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = `
        <div class="border-t border-slate-600 pt-4 mt-4">
            <h4 class="text-sm font-medium text-slate-300 mb-2">
                <i class="ri-mail-send-line mr-2 text-primary"></i>Pending Invitations (${invitations.length})
            </h4>
            ${invitations.map(invitation => {
                const expiresAt = new Date(invitation.expires_at);
                const isExpired = expiresAt < new Date();
                const isExpiringSoon = expiresAt < new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours

                return `
                <div class="flex items-center justify-between p-3 ${isExpired ? 'bg-red-500/10 border-red-500/30' : isExpiringSoon ? 'bg-yellow-500/10 border-yellow-500/30' : 'bg-blue-500/10 border-blue-500/30'} border rounded-lg mb-2">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <p class="text-sm font-medium text-white">${invitation.email}</p>
                            ${isExpired ? '<span class="ml-2 px-2 py-1 text-xs bg-red-500/20 text-red-400 border border-red-500/30 rounded-full">Expired</span>' : ''}
                            ${isExpiringSoon && !isExpired ? '<span class="ml-2 px-2 py-1 text-xs bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-full">Expires Soon</span>' : ''}
                        </div>
                        <p class="text-xs text-slate-400 mt-1">
                            Role: ${invitation.role.charAt(0).toUpperCase() + invitation.role.slice(1)} •
                            Invited by: ${invitation.invited_by} •
                            Expires: ${expiresAt.toLocaleDateString()} ${expiresAt.toLocaleTimeString()}
                        </p>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        ${!isExpired ? `
                            <button onclick="resendInvitation(${invitation.id})"
                                    class="text-primary hover:text-primary/80 text-xs px-2 py-1 border border-primary/30 rounded hover:bg-primary/10 transition-colors"
                                    title="Resend invitation email">
                                <i class="ri-mail-send-line mr-1"></i>Resend
                            </button>
                        ` : ''}
                        <button onclick="cancelInvitation(${invitation.id})"
                                class="text-red-400 hover:text-red-300 text-xs px-2 py-1 border border-red-400/30 rounded hover:bg-red-400/10 transition-colors"
                                title="Cancel invitation">
                            <i class="ri-close-line mr-1"></i>Cancel
                        </button>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;
}

function sendUserInvitation() {
    const email = document.getElementById('invite-email').value.trim();
    const role = document.getElementById('invite-role').value;

    // Clear previous errors
    clearFormErrors(['invite-email-error']);

    // Validate form
    if (!email) {
        showFieldError('invite-email-error', 'Email address is required');
        return;
    }

    if (!isValidEmail(email)) {
        showFieldError('invite-email-error', 'Please enter a valid email address');
        return;
    }

    // Show loading state
    setButtonLoading('send-invitation-btn', true);

    // Send invitation
    fetch('/api/settings/users/invite', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: email,
            role: role
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Invitation sent successfully!', 'success');
            document.getElementById('user-invitation-form').reset();
            loadTeamMembers(); // Reload the team members list
        } else {
            showFieldError('invite-email-error', data.error || 'Failed to send invitation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to send invitation', 'error');
    })
    .finally(() => {
        setButtonLoading('send-invitation-btn', false);
    });
}

function cancelInvitation(invitationId) {
    if (!confirm('Are you sure you want to cancel this invitation?')) {
        return;
    }

    fetch(`/api/settings/invitations/${invitationId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Invitation cancelled successfully!', 'success');
            loadTeamMembers(); // Reload the team members list
        } else {
            showNotification(data.error || 'Failed to cancel invitation', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to cancel invitation', 'error');
    });
}

function resendInvitation(invitationId) {
    fetch(`/api/settings/invitations/${invitationId}/resend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Invitation resent successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to resend invitation', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to resend invitation', 'error');
    });
}

function editUser(userId) {
    // Find the user data
    fetch('/api/settings/users')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
            return;
        }

        const user = data.users.find(u => u.id === userId);
        if (!user) {
            showNotification('User not found', 'error');
            return;
        }

        // Safety check - prevent editing yourself
        const currentUserEmail = getCurrentUserEmail();
        if (user.email === currentUserEmail) {
            showNotification('You cannot edit your own account', 'error');
            return;
        }

        // Create and show edit modal
        showEditUserModal(user);
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to load user data', 'error');
    });
}

function showEditUserModal(user) {
    // Create modal HTML
    const modalHtml = `
        <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">Edit User</h3>
                    <button onclick="closeEditUserModal()" class="text-slate-400 hover:text-white">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <form id="edit-user-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Username</label>
                        <input type="text" value="${user.username}" disabled
                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-300 cursor-not-allowed">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <input type="email" value="${user.email}" disabled
                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-300 cursor-not-allowed">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Role</label>
                        <select id="edit-user-role" class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                        </select>
                    </div>

                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="edit-user-active" ${user.is_active ? 'checked' : ''}
                                   class="mr-2 rounded border-slate-600 bg-slate-700 text-primary focus:ring-primary focus:ring-offset-slate-800">
                            <span class="text-sm text-slate-300">Active user</span>
                        </label>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-primary hover:bg-primary/90 text-slate-900 py-2 px-4 rounded-lg font-medium transition-colors">
                            Save Changes
                        </button>
                        <button type="button" onclick="closeEditUserModal()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Add form submit handler
    document.getElementById('edit-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveUserChanges(user.id);
    });
}

function closeEditUserModal() {
    const modal = document.getElementById('edit-user-modal');
    if (modal) {
        modal.remove();
    }
}

function saveUserChanges(userId) {
    const role = document.getElementById('edit-user-role').value;
    const isActive = document.getElementById('edit-user-active').checked;

    fetch(`/api/settings/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            role: role,
            is_active: isActive
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('User updated successfully!', 'success');
            closeEditUserModal();
            loadTeamMembers(); // Reload the team members list
        } else {
            showNotification(data.error || 'Failed to update user', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update user', 'error');
    });
}

function removeUser(userId) {
    // Get user info for confirmation
    fetch('/api/settings/users')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
            return;
        }

        const user = data.users.find(u => u.id === userId);
        if (!user) {
            showNotification('User not found', 'error');
            return;
        }

        // Safety checks
        const currentUserEmail = getCurrentUserEmail();
        if (user.email === currentUserEmail) {
            showNotification('You cannot remove yourself from the organization', 'error');
            return;
        }

        // Check if this is the organization owner
        if (user.permissions && user.permissions.can_manage_settings && user.role === 'admin') {
            showNotification('Cannot remove the organization owner', 'error');
            return;
        }

        // Show confirmation dialog
        if (confirm(`Are you sure you want to remove ${user.username} (${user.email}) from the organization? This action cannot be undone.`)) {
            // Proceed with removal
            fetch(`/api/settings/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('User removed successfully!', 'success');
                    loadTeamMembers(); // Reload the team members list
                } else {
                    showNotification(data.error || 'Failed to remove user', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to remove user', 'error');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to load user data', 'error');
    });
}

// Email Configuration Functions
function loadEmailConfiguration() {
    fetch('/api/settings/email/config')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error loading email config:', data.error);
            return;
        }

        // Update form fields
        if (data.smtp_host) document.getElementById('smtp-host').value = data.smtp_host;
        if (data.smtp_port) document.getElementById('smtp-port').value = data.smtp_port;
        if (data.smtp_username) document.getElementById('smtp-username').value = data.smtp_username;
        if (data.smtp_use_tls !== undefined) document.getElementById('smtp-use-tls').checked = data.smtp_use_tls;
        if (data.smtp_use_ssl !== undefined) document.getElementById('smtp-use-ssl').checked = data.smtp_use_ssl;
        if (data.from_email) document.getElementById('from-email').value = data.from_email;
        if (data.from_name) document.getElementById('from-name').value = data.from_name;
        if (data.reply_to) document.getElementById('reply-to').value = data.reply_to;

        // Update status badge
        updateEmailStatusBadge(data.is_configured, data.is_verified);
    })
    .catch(error => {
        console.error('Error loading email config:', error);
    });
}

function updateEmailStatusBadge(isConfigured, isVerified) {
    const badge = document.getElementById('email-status-badge');
    if (!badge) return;

    if (isVerified) {
        badge.className = 'ml-2 px-2 py-1 text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30 rounded-full';
        badge.textContent = 'Verified';
    } else if (isConfigured) {
        badge.className = 'ml-2 px-2 py-1 text-xs font-medium bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-full';
        badge.textContent = 'Not Verified';
    } else {
        badge.className = 'ml-2 px-2 py-1 text-xs font-medium bg-slate-500/20 text-slate-400 border border-slate-500/30 rounded-full';
        badge.textContent = 'Not Configured';
    }
}

function saveEmailConfiguration() {
    const formData = {
        smtp_host: document.getElementById('smtp-host').value.trim(),
        smtp_port: parseInt(document.getElementById('smtp-port').value),
        smtp_username: document.getElementById('smtp-username').value.trim(),
        smtp_password: document.getElementById('smtp-password').value,
        smtp_use_tls: document.getElementById('smtp-use-tls').checked,
        smtp_use_ssl: document.getElementById('smtp-use-ssl').checked,
        from_email: document.getElementById('from-email').value.trim(),
        from_name: document.getElementById('from-name').value.trim(),
        reply_to: document.getElementById('reply-to').value.trim()
    };

    // Validate required fields
    const requiredFields = ['smtp_host', 'smtp_port', 'smtp_username', 'smtp_password', 'from_email', 'from_name'];
    let hasErrors = false;

    requiredFields.forEach(field => {
        if (!formData[field]) {
            hasErrors = true;
        }
    });

    if (hasErrors) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    // Validate email addresses
    if (!isValidEmail(formData.from_email)) {
        showNotification('Please enter a valid from email address', 'error');
        return;
    }

    if (formData.reply_to && !isValidEmail(formData.reply_to)) {
        showNotification('Please enter a valid reply-to email address', 'error');
        return;
    }

    // Show loading state
    setButtonLoading('save-email-config-btn', true);

    // Send configuration
    fetch('/api/settings/email/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Email configuration saved successfully!', 'success');
            updateEmailStatusBadge(data.is_configured, false); // Not verified yet
        } else {
            showNotification(data.error || 'Failed to save email configuration', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to save email configuration', 'error');
    })
    .finally(() => {
        setButtonLoading('save-email-config-btn', false);
    });
}

function sendTestEmail() {
    const testEmail = document.getElementById('test-email').value.trim();

    if (!testEmail) {
        showNotification('Please enter a test email address', 'error');
        return;
    }

    if (!isValidEmail(testEmail)) {
        showNotification('Please enter a valid email address', 'error');
        return;
    }

    // Show loading state
    setButtonLoading('send-test-email-btn', true);

    // Clear previous status
    const statusDiv = document.getElementById('email-test-status');
    statusDiv.classList.add('hidden');

    // Send test email
    fetch('/api/settings/email/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            test_email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Test email sent successfully!', 'success');
            statusDiv.className = 'p-3 rounded-lg bg-green-500/20 border border-green-500/30';
            statusDiv.innerHTML = '<i class="ri-check-line text-green-400 mr-2"></i><span class="text-green-400">Test email sent successfully!</span>';
            statusDiv.classList.remove('hidden');

            // Update status badge to verified
            updateEmailStatusBadge(true, true);
        } else {
            showNotification(data.error || 'Failed to send test email', 'error');
            statusDiv.className = 'p-3 rounded-lg bg-red-500/20 border border-red-500/30';
            statusDiv.innerHTML = `<i class="ri-error-warning-line text-red-400 mr-2"></i><span class="text-red-400">${data.error || 'Failed to send test email'}</span>`;
            statusDiv.classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to send test email', 'error');
        statusDiv.className = 'p-3 rounded-lg bg-red-500/20 border border-red-500/30';
        statusDiv.innerHTML = '<i class="ri-error-warning-line text-red-400 mr-2"></i><span class="text-red-400">Failed to send test email</span>';
        statusDiv.classList.remove('hidden');
    })
    .finally(() => {
        setButtonLoading('send-test-email-btn', false);
    });
}

function sendTemplateTest() {
    const templateType = document.getElementById('template-type').value.trim();
    const testEmail = document.getElementById('template-test-email').value.trim();

    if (!templateType) {
        showNotification('Please select a template type', 'error');
        return;
    }

    if (!testEmail) {
        showNotification('Please enter a test email address', 'error');
        return;
    }

    if (!isValidEmail(testEmail)) {
        showNotification('Please enter a valid email address', 'error');
        return;
    }

    // Show loading state
    setButtonLoading('send-template-test-btn', true);

    // Clear previous status
    const statusDiv = document.getElementById('template-test-status');
    statusDiv.classList.add('hidden');

    // Send template test email
    fetch('/api/settings/email/test-templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            template_type: templateType,
            test_email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`${templateType.replace('_', ' ')} template test sent successfully!`, 'success');
            statusDiv.className = 'p-3 rounded-lg bg-green-500/20 border border-green-500/30';
            statusDiv.innerHTML = `<i class="ri-check-line text-green-400 mr-2"></i><span class="text-green-400">${templateType.replace('_', ' ')} template test sent successfully!</span>`;
            statusDiv.classList.remove('hidden');
        } else {
            showNotification(data.error || 'Failed to send template test', 'error');
            statusDiv.className = 'p-3 rounded-lg bg-red-500/20 border border-red-500/30';
            statusDiv.innerHTML = `<i class="ri-error-warning-line text-red-400 mr-2"></i><span class="text-red-400">${data.error || 'Failed to send template test'}</span>`;
            statusDiv.classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to send template test', 'error');
        statusDiv.className = 'p-3 rounded-lg bg-red-500/20 border border-red-500/30';
        statusDiv.innerHTML = '<i class="ri-error-warning-line text-red-400 mr-2"></i><span class="text-red-400">Failed to send template test</span>';
        statusDiv.classList.remove('hidden');
    })
    .finally(() => {
        setButtonLoading('send-template-test-btn', false);
    });
}

// Initialize enhanced functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadTeamMembers();
    loadEmailConfiguration();
    loadEmailNotificationSettings();

    // Add event listeners for new forms
    const userInvitationForm = document.getElementById('user-invitation-form');
    if (userInvitationForm) {
        userInvitationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendUserInvitation();
        });
    }

    const emailConfigForm = document.getElementById('email-config-form');
    if (emailConfigForm) {
        emailConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveEmailConfiguration();
        });
    }

    const testEmailForm = document.getElementById('test-email-form');
    if (testEmailForm) {
        testEmailForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendTestEmail();
        });
    }

    const templateTestForm = document.getElementById('template-test-form');
    if (templateTestForm) {
        templateTestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendTemplateTest();
        });
    }

    // Consolidated notification settings form
    const notificationSettingsForm = document.getElementById('notification-settings-form');
    if (notificationSettingsForm) {
        notificationSettingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveNotificationSettings();
        });
    }

    // Add invite button handler
    const inviteBtn = document.getElementById('invite-user-btn');
    if (inviteBtn) {
        inviteBtn.addEventListener('click', function() {
            // Focus on the email field in the invitation form
            const emailField = document.getElementById('invite-email');
            if (emailField) {
                emailField.focus();
            }
        });
    }
});

// Email Notification Settings Functions
function loadEmailNotificationSettings() {
    fetch('/api/settings/notifications')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error loading notification settings:', data.error);
            return;
        }

        // Populate email notification form
        document.getElementById('email-enabled').checked = data.email_enabled || false;
        document.getElementById('notification-email').value = data.notification_email || '';
        document.getElementById('additional-recipients').value = data.additional_recipients || '';
        document.getElementById('digest-frequency').value = data.digest_frequency || 'daily';

        // Populate alert threshold form
        const thresholds = data.alert_thresholds || {};
        document.getElementById('critical-alerts').checked = thresholds.critical !== false;
        document.getElementById('high-alerts').checked = thresholds.high !== false;
        document.getElementById('medium-alerts').checked = thresholds.medium !== false;
        document.getElementById('low-alerts').checked = thresholds.low === true;
        document.getElementById('info-alerts').checked = thresholds.info === true;
    })
    .catch(error => {
        console.error('Error loading notification settings:', error);
    });
}

function saveNotificationSettings() {
    // Collect data from both email notifications and alert thresholds sections
    const formData = {
        // Email notification settings
        email_enabled: document.getElementById('email-enabled').checked,
        notification_email: document.getElementById('notification-email').value.trim(),
        additional_recipients: document.getElementById('additional-recipients').value.trim(),
        digest_frequency: document.getElementById('digest-frequency').value,
        notify_scan_completion: document.getElementById('email-enabled').checked,
        notify_new_vulnerabilities: document.getElementById('email-enabled').checked,

        // Alert threshold settings
        alert_thresholds: {
            critical: document.getElementById('critical-alerts').checked,
            high: document.getElementById('high-alerts').checked,
            medium: document.getElementById('medium-alerts').checked,
            low: document.getElementById('low-alerts').checked,
            info: document.getElementById('info-alerts').checked
        }
    };

    // Validate notification email if provided
    if (formData.notification_email && !isValidEmail(formData.notification_email)) {
        showNotification('Please enter a valid notification email address', 'error');
        return;
    }

    // Validate additional recipients if provided
    if (formData.additional_recipients) {
        const additionalEmails = formData.additional_recipients.split(',').map(email => email.trim()).filter(email => email);
        for (const email of additionalEmails) {
            if (!isValidEmail(email)) {
                showNotification(`Invalid email address: ${email}`, 'error');
                return;
            }
        }
    }

    // Show loading state
    setButtonLoading('save-notification-settings-btn', true);

    // Send all notification settings in a single API call
    fetch('/api/settings/notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Notification settings saved successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to save notification settings', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to save notification settings', 'error');
    })
    .finally(() => {
        setButtonLoading('save-notification-settings-btn', false);
    });
}

// Helper function for button loading states
function setButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (!button) return;

    if (isLoading) {
        button.disabled = true;
        button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Saving...';
    } else {
        button.disabled = false;
        // Restore original text based on button ID
        if (buttonId === 'save-notification-settings-btn') {
            button.innerHTML = '<i class="ri-save-line mr-2"></i>Save Notification Settings';
        } else if (buttonId === 'save-email-settings-btn') {
            button.innerHTML = 'Save Email Settings';
        } else if (buttonId === 'save-alert-settings-btn') {
            button.innerHTML = 'Save Alert Settings';
        }
    }
}

</script>
{% endblock %}
